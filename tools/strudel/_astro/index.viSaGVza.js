/**
 * @license Fraction.js v4.3.7 31/08/2023
 * https://www.xarg.org/2014/03/rational-numbers-in-javascript/
 *
 * Copyright (c) 2023, Robert Eisele (robert@raw.org)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 **/var Xc=2e3,g={s:1,n:0,d:1};function ot(e,t){if(isNaN(e=parseInt(e,10)))throw xt();return e*t}function z(e,t){if(t===0)throw Xt();var n=Object.create(O.prototype);n.s=e<0?-1:1,e=e<0?-e:e;var s=mt(e,t);return n.n=e/s,n.d=t/s,n}function Te(e){for(var t={},n=e,s=2,r=4;r<=n;){for(;n%s===0;)n/=s,t[s]=(t[s]||0)+1;r+=1+2*s++}return n!==e?n>1&&(t[n]=(t[n]||0)+1):t[e]=(t[e]||0)+1,t}var U=function(e,t){var n=0,s=1,r=1,o=0,i=0,a=0,l=1,h=1,u=0,f=1,y=1,d=1,_=1e7,w;if(e!=null)if(t!==void 0){if(n=e,s=t,r=n*s,n%1!==0||s%1!==0)throw ea()}else switch(typeof e){case"object":{if("d"in e&&"n"in e)n=e.n,s=e.d,"s"in e&&(n*=e.s);else if(0 in e)n=e[0],1 in e&&(s=e[1]);else throw xt();r=n*s;break}case"number":{if(e<0&&(r=e,e=-e),e%1===0)n=e;else if(e>0){for(e>=1&&(h=Math.pow(10,Math.floor(1+Math.log(e)/Math.LN10)),e/=h);f<=_&&d<=_;)if(w=(u+y)/(f+d),e===w){f+d<=_?(n=u+y,s=f+d):d>f?(n=y,s=d):(n=u,s=f);break}else e>w?(u+=y,f+=d):(y+=u,d+=f),f>_?(n=y,s=d):(n=u,s=f);n*=h}else(isNaN(e)||isNaN(t))&&(s=n=NaN);break}case"string":{if(f=e.match(/\d+|./g),f===null)throw xt();if(f[u]==="-"?(r=-1,u++):f[u]==="+"&&u++,f.length===u+1?i=ot(f[u++],r):f[u+1]==="."||f[u]==="."?(f[u]!=="."&&(o=ot(f[u++],r)),u++,(u+1===f.length||f[u+1]==="("&&f[u+3]===")"||f[u+1]==="'"&&f[u+3]==="'")&&(i=ot(f[u],r),l=Math.pow(10,f[u].length),u++),(f[u]==="("&&f[u+2]===")"||f[u]==="'"&&f[u+2]==="'")&&(a=ot(f[u+1],r),h=Math.pow(10,f[u+1].length)-1,u+=3)):f[u+1]==="/"||f[u+1]===":"?(i=ot(f[u],r),l=ot(f[u+2],1),u+=3):f[u+3]==="/"&&f[u+1]===" "&&(o=ot(f[u],r),i=ot(f[u+2],r),l=ot(f[u+4],1),u+=5),f.length<=u){s=l*h,r=n=a+s*o+h*i;break}}default:throw xt()}if(s===0)throw Xt();g.s=r<0?-1:1,g.n=Math.abs(n),g.d=Math.abs(s)};function Yc(e,t,n){for(var s=1;t>0;e=e*e%n,t>>=1)t&1&&(s=s*e%n);return s}function Zc(e,t){for(;t%2===0;t/=2);for(;t%5===0;t/=5);if(t===1)return 0;for(var n=10%t,s=1;n!==1;s++)if(n=n*10%t,s>Xc)return 0;return s}function ta(e,t,n){for(var s=1,r=Yc(10,n,t),o=0;o<300;o++){if(s===r)return o;s=s*10%t,r=r*10%t}return 0}function mt(e,t){if(!e)return t;if(!t)return e;for(;;){if(e%=t,!e)return t;if(t%=e,!t)return e}}function O(e,t){if(U(e,t),this instanceof O)e=mt(g.d,g.n),this.s=g.s,this.n=g.n/e,this.d=g.d/e;else return z(g.s*g.n,g.d)}var Xt=function(){return new Error("Division by Zero")},xt=function(){return new Error("Invalid argument")},ea=function(){return new Error("Parameters must be integer")};O.prototype={s:1,n:0,d:1,abs:function(){return z(this.n,this.d)},neg:function(){return z(-this.s*this.n,this.d)},add:function(e,t){return U(e,t),z(this.s*this.n*g.d+g.s*this.d*g.n,this.d*g.d)},sub:function(e,t){return U(e,t),z(this.s*this.n*g.d-g.s*this.d*g.n,this.d*g.d)},mul:function(e,t){return U(e,t),z(this.s*g.s*this.n*g.n,this.d*g.d)},div:function(e,t){return U(e,t),z(this.s*g.s*this.n*g.d,this.d*g.n)},clone:function(){return z(this.s*this.n,this.d)},mod:function(e,t){if(isNaN(this.n)||isNaN(this.d))return new O(NaN);if(e===void 0)return z(this.s*this.n%this.d,1);if(U(e,t),g.n===0&&this.d===0)throw Xt();return z(this.s*(g.d*this.n)%(g.n*this.d),g.d*this.d)},gcd:function(e,t){return U(e,t),z(mt(g.n,this.n)*mt(g.d,this.d),g.d*this.d)},lcm:function(e,t){return U(e,t),g.n===0&&this.n===0?z(0,1):z(g.n*this.n,mt(g.n,this.n)*mt(g.d,this.d))},ceil:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new O(NaN):z(Math.ceil(e*this.s*this.n/this.d),e)},floor:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new O(NaN):z(Math.floor(e*this.s*this.n/this.d),e)},round:function(e){return e=Math.pow(10,e||0),isNaN(this.n)||isNaN(this.d)?new O(NaN):z(Math.round(e*this.s*this.n/this.d),e)},roundTo:function(e,t){return U(e,t),z(this.s*Math.round(this.n*g.d/(this.d*g.n))*g.n,g.d)},inverse:function(){return z(this.s*this.d,this.n)},pow:function(e,t){if(U(e,t),g.d===1)return g.s<0?z(Math.pow(this.s*this.d,g.n),Math.pow(this.n,g.n)):z(Math.pow(this.s*this.n,g.n),Math.pow(this.d,g.n));if(this.s<0)return null;var n=Te(this.n),s=Te(this.d),r=1,o=1;for(var i in n)if(i!=="1"){if(i==="0"){r=0;break}if(n[i]*=g.n,n[i]%g.d===0)n[i]/=g.d;else return null;r*=Math.pow(i,n[i])}for(var i in s)if(i!=="1"){if(s[i]*=g.n,s[i]%g.d===0)s[i]/=g.d;else return null;o*=Math.pow(i,s[i])}return g.s<0?z(o,r):z(r,o)},equals:function(e,t){return U(e,t),this.s*this.n*g.d===g.s*g.n*this.d},compare:function(e,t){U(e,t);var n=this.s*this.n*g.d-g.s*g.n*this.d;return(0<n)-(n<0)},simplify:function(e){if(isNaN(this.n)||isNaN(this.d))return this;e=e||.001;for(var t=this.abs(),n=t.toContinued(),s=1;s<n.length;s++){for(var r=z(n[s-1],1),o=s-2;o>=0;o--)r=r.inverse().add(n[o]);if(Math.abs(r.sub(t).valueOf())<e)return r.mul(this.s)}return this},divisible:function(e,t){return U(e,t),!(!(g.n*this.d)||this.n*g.d%(g.n*this.d))},valueOf:function(){return this.s*this.n/this.d},toFraction:function(e){var t,n="",s=this.n,r=this.d;return this.s<0&&(n+="-"),r===1?n+=s:(e&&(t=Math.floor(s/r))>0&&(n+=t,n+=" ",s%=r),n+=s,n+="/",n+=r),n},toLatex:function(e){var t,n="",s=this.n,r=this.d;return this.s<0&&(n+="-"),r===1?n+=s:(e&&(t=Math.floor(s/r))>0&&(n+=t,s%=r),n+="\\frac{",n+=s,n+="}{",n+=r,n+="}"),n},toContinued:function(){var e,t=this.n,n=this.d,s=[];if(isNaN(t)||isNaN(n))return s;do s.push(Math.floor(t/n)),e=t%n,t=n,n=e;while(t!==1);return s},toString:function(e){var t=this.n,n=this.d;if(isNaN(t)||isNaN(n))return"NaN";e=e||15;var s=Zc(t,n),r=ta(t,n,s),o=this.s<0?"-":"";if(o+=t/n|0,t%=n,t*=10,t&&(o+="."),s){for(var i=r;i--;)o+=t/n|0,t%=n,t*=10;o+="(";for(var i=s;i--;)o+=t/n|0,t%=n,t*=10;o+=")"}else for(var i=e;t&&i--;)o+=t/n|0,t%=n,t*=10;return o}};O.prototype.sam=function(){return this.floor()};O.prototype.nextSam=function(){return this.sam().add(1)};O.prototype.wholeCycle=function(){return new R(this.sam(),this.nextSam())};O.prototype.cyclePos=function(){return this.sub(this.sam())};O.prototype.lt=function(e){return this.compare(e)<0};O.prototype.gt=function(e){return this.compare(e)>0};O.prototype.lte=function(e){return this.compare(e)<=0};O.prototype.gte=function(e){return this.compare(e)>=0};O.prototype.eq=function(e){return this.compare(e)==0};O.prototype.ne=function(e){return this.compare(e)!=0};O.prototype.max=function(e){return this.gt(e)?this:e};O.prototype.maximum=function(...e){return e=e.map(t=>new O(t)),e.reduce((t,n)=>n.max(t),this)};O.prototype.min=function(e){return this.lt(e)?this:e};O.prototype.show=function(){return this.s*this.n+"/"+this.d};O.prototype.or=function(e){return this.eq(0)?e:this};const v=e=>O(e),na=(...e)=>e.reduce((t,n)=>t.gcd(n),v(1)),St=(...e)=>e.reduce((t,n)=>t.lcm(n),v(1));v._original=O;class R{constructor(t,n){this.begin=v(t),this.end=v(n)}get spanCycles(){const t=[];var n=this.begin;const s=this.end,r=s.sam();if(n.equals(s))return[new R(n,s)];for(;s.gt(n);){if(n.sam().equals(r)){t.push(new R(n,this.end));break}const o=n.nextSam();t.push(new R(n,o)),n=o}return t}get duration(){return this.end.sub(this.begin)}cycleArc(){const t=this.begin.cyclePos(),n=t.add(this.duration);return new R(t,n)}withTime(t){return new R(t(this.begin),t(this.end))}withEnd(t){return new R(this.begin,t(this.end))}withCycle(t){const n=this.begin.sam(),s=n.add(t(this.begin.sub(n))),r=n.add(t(this.end.sub(n)));return new R(s,r)}intersection(t){const n=this.begin.max(t.begin),s=this.end.min(t.end);if(!n.gt(s)&&!(n.equals(s)&&(n.equals(this.end)&&this.begin.lt(this.end)||n.equals(t.end)&&t.begin.lt(t.end))))return new R(n,s)}intersection_e(t){const n=this.intersection(t);if(n==null)throw"TimeSpans do not intersect";return n}midpoint(){return this.begin.add(this.duration.div(v(2)))}equals(t){return this.begin.equals(t.begin)&&this.end.equals(t.end)}show(){return this.begin.show()+" → "+this.end.show()}}class ${constructor(t,n,s,r={},o=!1){this.whole=t,this.part=n,this.value=s,this.context=r,this.stateful=o,o&&console.assert(typeof this.value=="function","Stateful values must be functions")}get duration(){let t;return typeof this.value?.duration=="number"?t=v(this.value.duration):t=this.whole.end.sub(this.whole.begin),typeof this.value?.clip=="number"?t.mul(this.value.clip):t}get endClipped(){return this.whole.begin.add(this.duration)}isActive(t){return this.whole.begin<=t&&this.endClipped>=t}isInPast(t){return t>this.endClipped}isInNearPast(t,n){return n-t<=this.endClipped}isInFuture(t){return t<this.whole.begin}isInNearFuture(t,n){return n<this.whole.begin&&n>this.whole.begin-t}isWithinTime(t,n){return this.whole.begin<=n&&this.endClipped>=t}wholeOrPart(){return this.whole?this.whole:this.part}withSpan(t){const n=this.whole?t(this.whole):void 0;return new $(n,t(this.part),this.value,this.context)}withValue(t){return new $(this.whole,this.part,t(this.value),this.context)}hasOnset(){return this.whole!=null&&this.whole.begin.equals(this.part.begin)}hasTag(t){return this.context.tags?.includes(t)}resolveState(t){if(this.stateful&&this.hasOnset()){console.log("stateful");const n=this.value,[s,r]=n(t);return[s,new $(this.whole,this.part,r,this.context,!1)]}return[t,this]}spanEquals(t){return this.whole==null&&t.whole==null||this.whole.equals(t.whole)}equals(t){return this.spanEquals(t)&&this.part.equals(t.part)&&this.value===t.value}show(t=!1){const n=typeof this.value=="object"?t?JSON.stringify(this.value).slice(1,-1).replaceAll('"',"").replaceAll(","," "):JSON.stringify(this.value):this.value;var s="";if(this.whole==null)s="~"+this.part.show;else{var r=this.whole.begin.equals(this.part.begin)&&this.whole.end.equals(this.part.end);this.whole.begin.equals(this.part.begin)||(s=this.whole.begin.show()+" ⇜ "),r||(s+="("),s+=this.part.show(),r||(s+=")"),this.whole.end.equals(this.part.end)||(s+=" ⇝ "+this.whole.end.show())}return"[ "+s+" | "+n+" ]"}showWhole(t=!1){return`${this.whole==null?"~":this.whole.show()}: ${typeof this.value=="object"?t?JSON.stringify(this.value).slice(1,-1).replaceAll('"',"").replaceAll(","," "):JSON.stringify(this.value):this.value}`}combineContext(t){const n=this;return{...n.context,...t.context,locations:(n.context.locations||[]).concat(t.context.locations||[])}}setContext(t){return new $(this.whole,this.part,this.value,t)}ensureObjectValue(){if(typeof this.value!="object")throw new Error(`expected hap.value to be an object, but got "${this.value}". Hint: append .note() or .s() to the end`,"error")}}class bt{constructor(t,n={}){this.span=t,this.controls=n}setSpan(t){return new bt(t,this.controls)}withSpan(t){return this.setSpan(t(this.span))}setControls(t){return new bt(this.span,t)}}const Yt="strudel.log";let sa=1e3,Ce,Me;function W(e,t,n={}){let s=performance.now();Ce===e&&s-Me<sa||(Ce=e,Me=s,console.log(`%c${e}`,"background-color: black;color:white;border-radius:15px"),typeof document<"u"&&typeof CustomEvent<"u"&&document.dispatchEvent(new CustomEvent(Yt,{detail:{message:e,type:t,data:n}})))}W.key=Yt;const ra=e=>/^[a-gA-G][#bs]*[0-9]$/.test(e),$t=e=>/^[a-gA-G][#bsf]*[0-9]?$/.test(e),je=e=>{if(typeof e!="string")return[];const[t,n="",s]=e.match(/^([a-gA-G])([#bsf]*)([0-9]*)$/)?.slice(1)||[];return t?[t,n,s?Number(s):void 0]:[]},oa={c:0,d:2,e:4,f:5,g:7,a:9,b:11},ia={"#":1,b:-1,s:1,f:-1},_t=(e,t=3)=>{const[n,s,r=t]=je(e);if(!n)throw new Error('not a note: "'+e+'"');const o=oa[n.toLowerCase()],i=s?.split("").reduce((a,l)=>a+ia[l],0)||0;return(Number(r)+1)*12+o+i},ft=e=>Math.pow(2,(e-69)/12)*440,Zt=e=>12*Math.log(e/440)/Math.LN2+69,ca=(e,t)=>{if(typeof e!="object")throw new Error("valueToMidi: expected object value");let{freq:n,note:s}=e;if(typeof n=="number")return Zt(n);if(typeof s=="string")return _t(s);if(typeof s=="number")return s;if(!t)throw new Error("valueToMidi: expected freq or note to be set");return t},aa=(e,t)=>(e-t)*1e3,$e=e=>ft(typeof e=="number"?e:_t(e)),ua=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],la=e=>{const t=Math.floor(e/12)-1;return ua[e%12]+t},Nt=(e,t)=>(e%t+t)%t;function Re(e,t=0){return isNaN(Number(e))?(W(`"${e}" is not a number, falling back to ${t}`,"warning"),t):e}const ha=(e,t)=>Nt(Math.round(Re(e??0,0)),t),fa=e=>{let{value:t,context:n}=e,s=t;if(typeof s=="object"&&!Array.isArray(s)&&(s=s.note||s.n||s.value,s===void 0))throw new Error(`cannot find a playable note for ${JSON.stringify(t)}`);if(typeof s=="number"&&n.type!=="frequency")s=ft(e.value);else if(typeof s=="number"&&n.type==="frequency")s=e.value;else if(typeof s!="string"||!$t(s))throw new Error("not a note: "+JSON.stringify(s));return s},Fe=e=>{let{value:t,context:n}=e;if(typeof t=="object")return t.freq?t.freq:$e(t.note||t.n||t.value);if(typeof t=="number"&&n.type!=="frequency")t=ft(e.value);else if(typeof t=="string"&&$t(t))t=ft(_t(e.value));else if(typeof t!="number")throw new Error("not a note or frequency: "+t);return t},Je=(e,t)=>e.slice(t).concat(e.slice(0,t)),Le=(...e)=>e.reduce((t,n)=>(...s)=>t(n(...s)),t=>t),pa=(...e)=>Le(...e.reverse()),Rt=e=>e.filter(t=>t!=null),ct=e=>[].concat(...e),yt=e=>e,da=(e,t)=>e,te=(e,t)=>Array.from({length:t-e+1},(n,s)=>s+e);function A(e,t,n=e.length){const s=function r(...o){if(o.length>=n)return e.apply(this,o);{const i=function(...a){return r.apply(this,o.concat(a))};return t&&t(i,o),i}};return t&&t(s,[]),s}function ee(e){const t=Number(e);if(!isNaN(t))return t;if($t(e))return _t(e);throw new Error(`cannot parse as numeral: "${e}"`)}function ne(e,t){return(...n)=>e(...n.map(t))}function K(e){return ne(e,ee)}function Ie(e){const t=Number(e);if(!isNaN(t))return t;const n={pi:Math.PI,w:1,h:.5,q:.25,e:.125,s:.0625,t:1/3,f:.2,x:1/6}[e];if(typeof n<"u")return n;throw new Error(`cannot parse as fractional: "${e}"`)}const ma=e=>ne(e,Ie),se=function(e,t){return[t.slice(0,e),t.slice(e)]},re=(e,t,n)=>t.map((s,r)=>e(s,n[r])),We=function(e){const t=[];for(let n=0;n<e.length-1;++n)t.push([e[n],e[n+1]]);return t},He=(e,t,n)=>Math.min(Math.max(e,t),n),ya=["Do","Reb","Re","Mib","Mi","Fa","Solb","Sol","Lab","La","Sib","Si"],ga=["Sa","Re","Ga","Ma","Pa","Dha","Ni"],wa=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Hb","H"],ba=["Ni","Pab","Pa","Voub","Vou","Ga","Dib","Di","Keb","Ke","Zob","Zo"],va=["I","Ro","Ha","Ni","Ho","He","To"],_a=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],ka=(e,t="letters")=>{const s=(t==="solfeggio"?ya:t==="indian"?ga:t==="german"?wa:t==="byzantine"?ba:t==="japanese"?va:_a)[e%12],r=Math.floor(e/12)-1;return s+r};function qa(e){var t={};return e.filter(function(n){return t.hasOwn(n)?!1:t[n]=!0})}function Aa(e){return e.sort().filter(function(t,n,s){return!n||t!=s[n-1]})}function De(e){return e.sort((t,n)=>t.compare(n)).filter(function(t,n,s){return!n||t.ne(s[n-1])})}function Ve(e){const t=new TextEncoder().encode(e);return btoa(String.fromCharCode(...t))}function Ge(e){const t=new Uint8Array(atob(e).split("").map(s=>s.charCodeAt(0)));return new TextDecoder().decode(t)}function Ta(e){return encodeURIComponent(Ve(e))}function Ca(e){return Ge(decodeURIComponent(e))}function Qe(e,t){return Array.isArray(e)?e.map(t):Object.fromEntries(Object.entries(e).map(([n,s],r)=>[n,t(s,n,r)]))}function Ma(e,t,n){if(t?.value!==void 0&&Object.keys(t).length===1)return W("[warn]: Can't do arithmetic on control pattern."),e;const s=Object.keys(e).filter(r=>Object.keys(t).includes(r));return Object.assign({},e,t,Object.fromEntries(s.map(r=>[r,n(e[r],t[r])])))}A((e,t)=>e*t);A((e,t)=>t.map(e));function Ue(e,t=60){let n=0,s=v(0),r=[""],o="";for(;r[0].length<t;){const i=e.queryArc(n,n+1),a=i.filter(u=>u.hasOnset()).map(u=>u.duration),l=na(...a),h=l.inverse();r=r.map(u=>u+"|"),o+="|";for(let u=0;u<h;u++){const[f,y]=[s,s.add(l)],d=i.filter(w=>w.whole.begin.lte(f)&&w.whole.end.gte(y)),_=d.length-r.length;_>0&&(r=r.concat(Array(_).fill(o))),r=r.map((w,q)=>{const k=d[q];if(k){const E=k.whole.begin.eq(f)?""+k.value:"-";return w+E}return w+"."}),o+=".",s=s.add(l)}n++}return r.join(`
`)}let Ht;const Sa=e=>Ht=e;class m{constructor(t,n=void 0){this.query=t,this._Pattern=!0,this.__tactus=v(n)}get tactus(){return this.__tactus??v(1)}set tactus(t){this.__tactus=v(t)}setTactus(t){return this.tactus=t,this}withTactus(t){return new m(this.query,this.tactus===void 0?void 0:t(this.tactus))}withValue(t){const n=new m(s=>this.query(s).map(r=>r.withValue(t)));return n.tactus=this.tactus,n}fmap(t){return this.withValue(t)}appWhole(t,n){const s=this,r=function(o){const i=s.query(o),a=n.query(o),l=function(h,u){const f=h.part.intersection(u.part);if(f!=null)return new $(t(h.whole,u.whole),f,h.value(u.value),u.combineContext(h))};return ct(i.map(h=>Rt(a.map(u=>l(h,u)))))};return new m(r)}appBoth(t){const n=this,s=function(o,i){if(!(o==null||i==null))return o.intersection_e(i)},r=n.appWhole(s,t);return r.tactus=St(t.tactus,n.tactus),r}appLeft(t){const n=this,s=function(o){const i=[];for(const a of n.query(o)){const l=t.query(o.setSpan(a.wholeOrPart()));for(const h of l){const u=a.whole,f=a.part.intersection(h.part);if(f){const y=a.value(h.value),d=h.combineContext(a),_=new $(u,f,y,d);i.push(_)}}}return i},r=new m(s);return r.tactus=this.tactus,r}appRight(t){const n=this,s=function(o){const i=[];for(const a of t.query(o)){const l=n.query(o.setSpan(a.wholeOrPart()));for(const h of l){const u=a.whole,f=h.part.intersection(a.part);if(f){const y=h.value(a.value),d=a.combineContext(h),_=new $(u,f,y,d);i.push(_)}}}return i},r=new m(s);return r.tactus=t.tactus,r}bindWhole(t,n){const s=this,r=function(o){const i=function(l,h){return new $(t(l.whole,h.whole),h.part,h.value,Object.assign({},l.context,h.context,{locations:(l.context.locations||[]).concat(h.context.locations||[])}))},a=function(l){return n(l.value).query(o.setSpan(l.part)).map(h=>i(l,h))};return ct(s.query(o).map(l=>a(l)))};return new m(r)}bind(t){const n=function(s,r){if(!(s==null||r==null))return s.intersection_e(r)};return this.bindWhole(n,t)}join(){return this.bind(yt)}outerBind(t){return this.bindWhole(n=>n,t).setTactus(this.tactus)}outerJoin(){return this.outerBind(yt)}innerBind(t){return this.bindWhole((n,s)=>s,t)}innerJoin(){return this.innerBind(yt)}resetJoin(t=!1){const n=this;return new m(s=>n.discreteOnly().query(s).map(r=>r.value.late(t?r.whole.begin:r.whole.begin.cyclePos()).query(s).map(o=>new $(o.whole?o.whole.intersection(r.whole):void 0,o.part.intersection(r.part),o.value).setContext(r.combineContext(o))).filter(o=>o.part)).flat())}restartJoin(){return this.resetJoin(!0)}squeezeJoin(){const t=this;function n(s){const r=t.discreteOnly().query(s);function o(a){const h=a.value._focusSpan(a.wholeOrPart()).query(s.setSpan(a.part));function u(f,y){let d;if(y.whole&&f.whole&&(d=y.whole.intersection(f.whole),!d))return;const _=y.part.intersection(f.part);if(!_)return;const w=y.combineContext(f);return new $(d,_,y.value,w)}return h.map(f=>u(a,f))}return ct(r.map(o)).filter(a=>a)}return new m(n)}squeezeBind(t){return this.fmap(t).squeezeJoin()}queryArc(t,n,s={}){try{return this.query(new bt(new R(t,n),s))}catch(r){return W(`[query]: ${r.message}`,"error"),[]}}splitQueries(){const t=this,n=s=>ct(s.span.spanCycles.map(r=>t.query(s.setSpan(r))));return new m(n)}withQuerySpan(t){return new m(n=>this.query(n.withSpan(t)))}withQuerySpanMaybe(t){const n=this;return new m(s=>{const r=s.withSpan(t);return r.span?n.query(r):[]})}withQueryTime(t){return new m(n=>this.query(n.withSpan(s=>s.withTime(t))))}withHapSpan(t){return new m(n=>this.query(n).map(s=>s.withSpan(t)))}withHapTime(t){return this.withHapSpan(n=>n.withTime(t))}withHaps(t){const n=new m(s=>t(this.query(s),s));return n.tactus=this.tactus,n}withHap(t){return this.withHaps(n=>n.map(t))}setContext(t){return this.withHap(n=>n.setContext(t))}withContext(t){const n=this.withHap(s=>s.setContext(t(s.context)));return this.__pure!==void 0&&(n.__pure=this.__pure,n.__pure_loc=this.__pure_loc),n}stripContext(){return this.withHap(t=>t.setContext({}))}withLoc(t,n){const s={start:t,end:n},r=this.withContext(o=>{const i=(o.locations||[]).concat([s]);return{...o,locations:i}});return this.__pure&&(r.__pure=this.__pure,r.__pure_loc=s),r}filterHaps(t){return new m(n=>this.query(n).filter(t))}filterValues(t){return new m(n=>this.query(n).filter(s=>t(s.value))).setTactus(this.tactus)}removeUndefineds(){return this.filterValues(t=>t!=null)}onsetsOnly(){return this.filterHaps(t=>t.hasOnset())}discreteOnly(){return this.filterHaps(t=>t.whole)}defragmentHaps(){return this.discreteOnly().withHaps(n=>{const s=[];for(var r=0;r<n.length;++r){for(var o=!0,i=n[r];o;){const h=JSON.stringify(n[r].value);for(var a=!1,l=r+1;l<n.length;l++){const u=n[l];if(i.whole.equals(u.whole)){if(i.part.begin.eq(u.part.end)){if(h===JSON.stringify(u.value)){i=new $(i.whole,new R(u.part.begin,i.part.end),i.value),n.splice(l,1),a=!0;break}}else if(u.part.begin.eq(i.part.end)&&h==JSON.stringify(u.value)){i=new $(i.whole,new R(i.part.begin,u.part.end),i.value),n.splice(l,1),a=!0;break}}}o=a}s.push(i)}return s})}firstCycle(t=!1){var n=this;return t||(n=n.stripContext()),n.query(new bt(new R(v(0),v(1))))}get firstCycleValues(){return this.firstCycle().map(t=>t.value)}get showFirstCycle(){return this.firstCycle().map(t=>`${t.value}: ${t.whole.begin.toFraction()} - ${t.whole.end.toFraction()}`)}sortHapsByPart(){return this.withHaps(t=>t.sort((n,s)=>n.part.begin.sub(s.part.begin).or(n.part.end.sub(s.part.end)).or(n.whole.begin.sub(s.whole.begin).or(n.whole.end.sub(s.whole.end)))))}asNumber(){return this.fmap(ee)}_opIn(t,n){return this.fmap(n).appLeft(b(t))}_opOut(t,n){return this.fmap(n).appRight(b(t))}_opMix(t,n){return this.fmap(n).appBoth(b(t))}_opSqueeze(t,n){const s=b(t);return this.fmap(r=>s.fmap(o=>n(r)(o))).squeezeJoin()}_opSqueezeOut(t,n){const s=this;return b(t).fmap(o=>s.fmap(i=>n(i)(o))).squeezeJoin()}_opReset(t,n){return b(t).fmap(r=>this.fmap(o=>n(o)(r))).resetJoin()}_opRestart(t,n){return b(t).fmap(r=>this.fmap(o=>n(o)(r))).restartJoin()}layer(...t){return F(...t.map(n=>n(this)))}superimpose(...t){return this.stack(...t.map(n=>n(this)))}stack(...t){return F(this,...t)}sequence(...t){return et(this,...t)}seq(...t){return et(this,...t)}cat(...t){return Ze(this,...t)}fastcat(...t){return at(this,...t)}slowcat(...t){return ht(this,...t)}onTrigger(t,n=!0){return this.withHap(s=>s.setContext({...s.context,onTrigger:(...r)=>{s.context.onTrigger?.(...r),t(...r)},dominantTrigger:s.context.dominantTrigger||n}))}log(t=(s,r)=>`[hap] ${r.showWhole(!0)}`,n=(s,r)=>({hap:r})){return this.onTrigger((...s)=>{W(t(...s),void 0,n(...s))},!1)}logValues(t=yt){return this.log((n,s)=>t(s.value))}drawLine(){return console.log(Ue(this)),this}}function Na(e,t){let n=[];return t.forEach(s=>{const r=n.findIndex(([o])=>e(s,o));r===-1?n.push([s]):n[r].push(s)}),n}const Oa=(e,t)=>e.spanEquals(t);m.prototype.collect=function(){return this.withHaps(e=>Na(Oa,e).map(t=>new $(t[0].whole,t[0].part,t,{})))};m.prototype.arpWith=function(e){return this.collect().fmap(t=>b(e(t))).innerJoin().withHap(t=>new $(t.whole,t.part,t.value.value,t.combineContext(t.value)))};m.prototype.arp=function(e){return this.arpWith(t=>e.fmap(n=>t[n%t.length]))};function Et(e){return!Array.isArray(e)&&typeof e=="object"}function Ba(e,t,n){return Et(e)||Et(t)?(Et(e)||(e={value:e}),Et(t)||(t={value:t}),Ma(e,t,n)):n(e,t)}(function(){const e={set:[(n,s)=>s],keep:[n=>n],keepif:[(n,s)=>s?n:void 0],add:[K((n,s)=>n+s)],sub:[K((n,s)=>n-s)],mul:[K((n,s)=>n*s)],div:[K((n,s)=>n/s)],mod:[K(Nt)],pow:[K(Math.pow)],band:[K((n,s)=>n&s)],bor:[K((n,s)=>n|s)],bxor:[K((n,s)=>n^s)],blshift:[K((n,s)=>n<<s)],brshift:[K((n,s)=>n>>s)],lt:[(n,s)=>n<s],gt:[(n,s)=>n>s],lte:[(n,s)=>n<=s],gte:[(n,s)=>n>=s],eq:[(n,s)=>n==s],eqt:[(n,s)=>n===s],ne:[(n,s)=>n!=s],net:[(n,s)=>n!==s],and:[(n,s)=>n&&s],or:[(n,s)=>n||s],func:[(n,s)=>s(n)]},t=["In","Out","Mix","Squeeze","SqueezeOut","Reset","Restart"];for(const[n,[s,r]]of Object.entries(e)){m.prototype["_"+n]=function(o){return this.fmap(i=>s(i,o))},Object.defineProperty(m.prototype,n,{get:function(){const o=this,i=(...a)=>o[n].in(...a);for(const a of t)i[a.toLowerCase()]=function(...l){var h=o;l=et(l),r&&(h=r(h),l=r(l));var u;return n==="keepif"?(u=h["_op"+a](l,f=>y=>s(f,y)),u=u.removeUndefineds()):u=h["_op"+a](l,f=>y=>Ba(f,y,s)),u};return i.squeezein=i.squeeze,i}});for(const o of t)m.prototype[o.toLowerCase()]=function(...i){return this.set[o.toLowerCase()](i)}}m.prototype.struct=function(...n){return this.keepif.out(...n)},m.prototype.structAll=function(...n){return this.keep.out(...n)},m.prototype.mask=function(...n){return this.keepif.in(...n)},m.prototype.maskAll=function(...n){return this.keep.in(...n)},m.prototype.reset=function(...n){return this.keepif.reset(...n)},m.prototype.resetAll=function(...n){return this.keep.reset(...n)},m.prototype.restart=function(...n){return this.keepif.restart(...n)},m.prototype.restartAll=function(...n){return this.keep.restart(...n)}})();const Pa=F,za=F,Ea=he,kt=e=>new m(()=>[],v(e)),P=kt(1),gt=kt(0);function nt(e){function t(s){return s.span.spanCycles.map(r=>new $(v(r.begin).wholeCycle(),r,e))}const n=new m(t,1);return n.__pure=e,n}function oe(e){return e instanceof m||e?._Pattern}function b(e){return oe(e)?e:Ht&&typeof e=="string"?Ht(e):nt(e)}function F(...e){e=e.map(s=>Array.isArray(s)?et(...s):b(s));const t=s=>ct(e.map(r=>r.query(s))),n=new m(t);return n.tactus=St(...e.map(s=>s.tactus)),n}function ie(e,t){if(t=t.map(o=>Array.isArray(o)?et(...o):b(o)),t.length===0)return P;if(t.length===1)return t[0];const[n,...s]=t.map(o=>o.tactus),r=n.maximum(...s);return F(...e(r,t))}function Ke(...e){return ie((t,n)=>n.map(s=>s.tactus.eq(t)?s:X(s,kt(t.sub(s.tactus)))),e)}function Xe(...e){return ie((t,n)=>n.map(s=>s.tactus.eq(t)?s:X(kt(t.sub(s.tactus)),s)),e)}function Ye(...e){return ie((t,n)=>n.map(s=>{if(s.tactus.eq(t))return s;const r=kt(t.sub(s.tactus).div(2));return X(r,s,r)}),e)}function xa(e,...t){const[n,...s]=t.map(i=>i.tactus),r=n.maximum(...s),o={centre:Ye,left:Ke,right:Xe,expand:F,repeat:(...i)=>on(r,...i)};return e.inhabit(o).fmap(i=>i(...t)).innerJoin().setTactus(r)}function ht(...e){if(e=e.map(s=>Array.isArray(s)?at(...s):b(s)),e.length==1)return e[0];const t=function(s){const r=s.span,o=Nt(r.begin.sam(),e.length),i=e[o];if(!i)return[];const a=r.begin.floor().sub(r.begin.div(e.length).floor());return i.withHapTime(l=>l.add(a)).query(s.setSpan(r.withTime(l=>l.sub(a))))},n=St(...e.map(s=>s.tactus));return new m(t).splitQueries().setTactus(n)}function ce(...e){e=e.map(b);const t=function(n){const s=Math.floor(n.span.begin)%e.length;return e[s]?.query(n)||[]};return new m(t).splitQueries()}function Ze(...e){return ht(...e)}function ja(...e){const t=e.reduce((n,[s])=>n+s,0);return e=e.map(([n,s])=>[n,s.fast(n)]),X(...e).slow(t)}function at(...e){let t=ht(...e);return e.length>1&&(t=t._fast(e.length),t.tactus=e.length),t}function et(...e){return at(...e)}function tn(...e){return at(...e)}function Dt(e){return Array.isArray(e)?e.length==0?[P,0]:e.length==1?Dt(e[0]):[at(...e.map(t=>Dt(t)[0])),e.length]:[b(e),1]}const $a=A((e,t)=>b(t).mask(e)),Ra=A((e,t)=>b(t).struct(e)),Fa=A((e,t)=>b(t).superimpose(...e)),Ja=A((e,t)=>b(t).set(e)),La=A((e,t)=>b(t).keep(e)),Ia=A((e,t)=>b(t).keepif(e)),Wa=A((e,t)=>b(t).add(e)),Ha=A((e,t)=>b(t).sub(e)),Da=A((e,t)=>b(t).mul(e)),Va=A((e,t)=>b(t).div(e)),Ga=A((e,t)=>b(t).mod(e)),Qa=A((e,t)=>b(t).pow(e)),Ua=A((e,t)=>b(t).band(e)),Ka=A((e,t)=>b(t).bor(e)),Xa=A((e,t)=>b(t).bxor(e)),Ya=A((e,t)=>b(t).blshift(e)),Za=A((e,t)=>b(t).brshift(e)),tu=A((e,t)=>b(t).lt(e)),eu=A((e,t)=>b(t).gt(e)),nu=A((e,t)=>b(t).lte(e)),su=A((e,t)=>b(t).gte(e)),ru=A((e,t)=>b(t).eq(e)),ou=A((e,t)=>b(t).eqt(e)),iu=A((e,t)=>b(t).ne(e)),cu=A((e,t)=>b(t).net(e)),au=A((e,t)=>b(t).and(e)),uu=A((e,t)=>b(t).or(e)),lu=A((e,t)=>b(t).func(e));function p(e,t,n=!0,s=!1,r=o=>o.innerJoin()){if(Array.isArray(e)){const a={};for(const l of e)a[l]=p(l,t,n);return a}const o=t.length;var i;return n?i=function(...a){a=a.map(b);const l=a[a.length-1];let h;if(o===1)h=t(l);else{const u=a.slice(0,-1);if(u.every(f=>f.__pure!=null)){const f=u.map(d=>d.__pure),y=u.filter(d=>d.__pure_loc).map(d=>d.__pure_loc);h=t(...f,l),h=h.withContext(d=>{const _=(d.locations||[]).concat(y);return{...d,locations:_}})}else{const[f,...y]=u;let d=(..._)=>t(..._,l);d=A(d,null,o-1),h=r(y.reduce((_,w)=>_.appLeft(w),f.fmap(d)))}}return s&&(h.tactus=l.tactus),h}:i=function(...a){a=a.map(b);const l=t(...a);return s&&(l.tactus=a[a.length-1].tactus),l},m.prototype[e]=function(...a){if(o===2&&a.length!==1)a=[et(...a)];else if(o!==a.length+1)throw new Error(`.${e}() expects ${o-1} inputs but got ${a.length}.`);return a=a.map(b),i(...a,this)},o>1&&(m.prototype["_"+e]=function(...a){return t(...a,this)}),A(i,null,o)}function Ft(e,t,n=!0,s=!1,r=o=>o.stepJoin()){return p(e,t,n,s,r)}const hu=p("round",function(e){return e.asNumber().fmap(t=>Math.round(t))}),fu=p("floor",function(e){return e.asNumber().fmap(t=>Math.floor(t))}),pu=p("ceil",function(e){return e.asNumber().fmap(t=>Math.ceil(t))}),du=p("toBipolar",function(e){return e.fmap(t=>t*2-1)}),mu=p("fromBipolar",function(e){return e.fmap(t=>(t+1)/2)}),yu=p("range",function(e,t,n){return n.mul(t-e).add(e)}),gu=p("rangex",function(e,t,n){return n._range(Math.log(e),Math.log(t)).fmap(Math.exp)}),wu=p("range2",function(e,t,n){return n.fromBipolar()._range(e,t)}),bu=p("ratio",e=>e.fmap(t=>Array.isArray(t)?t.slice(1).reduce((n,s)=>n/s,t[0]):t)),vu=p("compress",function(e,t,n){return e=v(e),t=v(t),e.gt(t)||e.gt(1)||t.gt(1)||e.lt(0)||t.lt(0)?P:n._fastGap(v(1).div(t.sub(e)))._late(e)}),{compressSpan:_u,compressspan:ku}=p(["compressSpan","compressspan"],function(e,t){return t._compress(e.begin,e.end)}),{fastGap:qu,fastgap:Au}=p(["fastGap","fastgap"],function(e,t){const n=function(r){const o=r.begin.sam(),i=r.begin.sub(o).mul(e).min(1),a=r.end.sub(o).mul(e).min(1);if(!(i>=1))return new R(o.add(i),o.add(a))},s=function(r){const o=r.part.begin,i=r.part.end,a=o.sam(),l=o.sub(a).div(e).min(1),h=i.sub(a).div(e).min(1),u=new R(a.add(l),a.add(h)),f=r.whole?new R(u.begin.sub(o.sub(r.whole.begin).div(e)),u.end.add(r.whole.end.sub(i).div(e))):void 0;return new $(f,u,r.value,r.context)};return t.withQuerySpanMaybe(n).withHap(s).splitQueries()}),Tu=p("focus",function(e,t,n){return e=v(e),t=v(t),n._fast(v(1).div(t.sub(e))).late(e.cyclePos())}),{focusSpan:Cu,focusspan:Mu}=p(["focusSpan","focusspan"],function(e,t){return t._focus(e.begin,e.end)}),Su=p("ply",function(e,t){const n=t.fmap(s=>nt(s)._fast(e)).squeezeJoin();return n.tactus=t.tactus.mul(e),n}),{fast:Nu,density:pf}=p(["fast","density"],function(e,t){if(e===0)return P;e=v(e);const s=t.withQueryTime(r=>r.mul(e)).withHapTime(r=>r.div(e));return s.tactus=e.mul(t.tactus),s}),Ou=p("hurry",function(e,t){return t._fast(e).mul(nt({speed:e}))}),{slow:Bu,sparsity:Pu}=p(["slow","sparsity"],function(e,t){return e===0?P:t._fast(v(1).div(e))}),zu=p("inside",function(e,t,n){return t(n._slow(e))._fast(e)}),Eu=p("outside",function(e,t,n){return t(n._fast(e))._slow(e)}),xu=p("lastOf",function(e,t,n){const s=Array(e-1).fill(n);return s.push(t(n)),ce(...s)}),{firstOf:ju,every:$u}=p(["firstOf","every"],function(e,t,n){const s=Array(e-1).fill(n);return s.unshift(t(n)),ce(...s)}),Ru=p("apply",function(e,t){return e(t)}),Fu=p("cpm",function(e,t){return t._fast(e/60/1)}),Ju=p("early",function(e,t){return e=v(e),t.withQueryTime(n=>n.add(e)).withHapTime(n=>n.sub(e))},!0,!0),en=p("late",function(e,t){return e=v(e),t._early(v(0).sub(e))},!0,!0),Lu=p("zoom",function(e,t,n){if(t=v(t),e=v(e),e.gte(t))return gt;const s=t.sub(e),r=n.tactus.mul(s);return n.withQuerySpan(o=>o.withCycle(i=>i.mul(s).add(e))).withHapSpan(o=>o.withCycle(i=>i.sub(e).div(s))).splitQueries().setTactus(r)}),{zoomArc:Iu,zoomarc:Wu}=p(["zoomArc","zoomarc"],function(e,t){return t.zoom(e.begin,e.end)}),Hu=p("linger",function(e,t){return e==0?P:e<0?t._zoom(e.add(1),1)._slow(e):t._zoom(0,e)._slow(e)},!0,!0),Du=p("segment",function(e,t){return t.struct(nt(!0)._fast(e)).setTactus(e)}),Vu=p("swingBy",(e,t,n)=>n.inside(t,en(tn(0,e/2)))),Gu=p("swing",(e,t)=>t.swingBy(1/3,e)),{invert:Qu,inv:Uu}=p(["invert","inv"],function(e){return e.fmap(t=>!t)},!0,!0),Ku=p("when",function(e,t,n){return e?t(n):n}),Xu=p("off",function(e,t,n){return F(n,t(n.late(e)))}),Yu=p("brak",function(e){return e.when(ht(!1,!0),t=>at(t,P)._late(.25))}),nn=p("rev",function(e){const t=function(n){const s=n.span,r=s.begin.sam(),o=s.begin.nextSam(),i=function(l){const h=l.withTime(f=>r.add(o.sub(f))),u=h.begin;return h.begin=h.end,h.end=u,h};return e.query(n.setSpan(i(s))).map(l=>l.withSpan(i))};return new m(t).splitQueries()},!1,!0),Zu=p("pressBy",function(e,t){return t.fmap(n=>nt(n).compress(e,1)).squeezeJoin()}),tl=p("press",function(e){return e._pressBy(.5)});m.prototype.hush=function(){return P};const el=p("palindrome",function(e){return e.lastOf(2,nn)},!0,!0),{juxBy:nl,juxby:sl}=p(["juxBy","juxby"],function(e,t,n){e/=2;const s=function(i,a,l){return a in i?i[a]:l},r=n.withValue(i=>Object.assign({},i,{pan:s(i,"pan",.5)-e})),o=t(n.withValue(i=>Object.assign({},i,{pan:s(i,"pan",.5)+e})));return F(r,o).setTactus(St(r.tactus,o.tactus))}),rl=p("jux",function(e,t){return t._juxBy(1,e,t)}),{echoWith:ol,echowith:il,stutWith:cl,stutwith:al}=p(["echoWith","echowith","stutWith","stutwith"],function(e,t,n,s){return F(...te(0,e-1).map(r=>n(s.late(v(t).mul(r)),r)))}),ul=p("echo",function(e,t,n,s){return s._echoWith(e,t,(r,o)=>r.gain(Math.pow(n,o)))}),ll=p("stut",function(e,t,n,s){return s._echoWith(e,n,(r,o)=>r.gain(Math.pow(t,o)))}),ae=function(e,t,n=!1){return e=v(e),ht(...te(0,e.sub(1)).map(s=>n?t.late(v(s).div(e)):t.early(v(s).div(e))))},hl=p("iter",function(e,t){return ae(e,t,!1)},!0,!0),{iterBack:fl,iterback:pl}=p(["iterBack","iterback"],function(e,t){return ae(e,t,!0)},!0,!0),{repeatCycles:dl}=p("repeatCycles",function(e,t){return ht(...Array(e).fill(t))},!0,!0),ue=function(e,t,n,s=!1,r=!1){const o=Array(e-1).fill(!1);o.unshift(!0);const i=ae(e,et(...o),!s);return r||(n=n.repeatCycles(e)),n.when(i,t)},{chunk:ml,slowchunk:yl,slowChunk:gl}=p(["chunk","slowchunk","slowChunk"],function(e,t,n){return ue(e,t,n,!1,!1)}),{chunkBack:wl,chunkback:bl}=p(["chunkBack","chunkback"],function(e,t,n){return ue(e,t,n,!0)}),{fastchunk:vl,fastChunk:_l}=p(["fastchunk","fastChunk"],function(e,t,n){return ue(e,t,n,!1,!0)}),kl=p("bypass",function(e,t){return e=!!parseInt(e),e?P:t},!0,!0),ql=p("ribbon",(e,t,n)=>n.early(e).restart(nt(1).slow(t))),Al=p("hsla",(e,t,n,s,r)=>r.color(`hsla(${e}turn,${t*100}%,${n*100}%,${s})`)),Tl=p("hsl",(e,t,n,s)=>s.color(`hsl(${e}turn,${t*100}%,${n*100}%)`));m.prototype.tag=function(e){return this.withContext(t=>({...t,tags:(t.tags||[]).concat([e])}))};m.prototype.stepJoin=function(){const e=this,t=X(...Vt(Gt(e.queryArc(0,1)))).tactus,n=function(s){const o=e.early(s.span.begin.sam()).query(s.setSpan(new R(v(0),v(1))));return X(...Vt(Gt(o))).query(s)};return new m(n,t)};function Vt(e){const t=e.filter((o,i)=>i.tactus!=null).reduce((o,i)=>o.add(i),v(0)),n=Rt(e.map((o,i)=>i.tactus)).reduce((o,i)=>o.add(i),v(0)),s=t.eq(0)?0:n.div(t);function r(o,i){return i.tactus===void 0?[o.mul(s),i]:[i.tactus,i]}return e.map(o=>r(...o))}function Gt(e){const t=ct(e.map(r=>[r.part.begin,r.part.end])),n=De([v(0),v(1),...t]);return We(n).map(r=>[r[1].sub(r[0]),F(...sn(new R(...r),e).map(o=>o.value.withHap(i=>i.setContext(i.combineContext(o)))))])}function sn(e,t){return Rt(t.map(n=>rn(e,n)))}function rn(e,t){const n=e.intersection(t.part);if(n!=null)return new $(t.whole,n,t.value,t.context)}const Cl=p("steps",function(e,t){return t.tactus.eq(0)?gt:t.fast(v(e).div(t.tactus))});function le(e,...t){const n=t.map(r=>Dt(r));if(n.length==0)return P;e==0&&(e=n[0][1]);const s=[];for(const r of n)r[1]!=0&&(e==r[1]?s.push(r[0]):s.push(r[0]._fast(v(e).div(v(r[1])))));return F(...s)}function on(e,...t){return t.length==0?P:Array.isArray(t[0])?le(e,...t):he(...t).steps(e)}function he(...e){if(Array.isArray(e[0]))return le(0,...e);if(e.length==0)return P;const t=e[0].tactus,[n,...s]=e,r=F(n,...s.map(o=>o._slow(o.tactus.div(t))));return r.tactus=t,r}function X(...e){const t=i=>Array.isArray(i)?i:[i.tactus,i];if(e=e.map(t),e.length==1){const i=b(e[0][1]);return i.tactus=e[0][0],i}const n=e.map(i=>i[0]).reduce((i,a)=>i.add(a),v(0));let s=v(0);const r=[];for(const[i,a]of e){if(v(i).eq(0))continue;const l=s.add(i);r.push(b(a)._compress(s.div(n),l.div(n))),s=l}const o=F(...r);return o.tactus=n,o}const Ml=X,cn=X;function Sl(...e){e=e.map(r=>Array.isArray(r)?r.map(b):[b(r)]);const t=St(...e.map(r=>v(r.length)));let n=[];for(let r=0;r<t;++r)n.push(...e.map(o=>o.length==0?P:o[r%o.length]));n=n.filter(r=>r.tactus>0);const s=n.reduce((r,o)=>r.add(o.tactus),v(0));return n=X(...n),n.tactus=s,n}const Nl=Ft("s_add",function(e,t){if(t.tactus.lte(0)||(e=v(e),e.eq(0)))return gt;const n=e<0;n&&(e=e.abs());const s=e.div(t.tactus);return s.lte(0)?gt:s.gte(1)?t:n?t.zoom(v(1).sub(s),1):t.zoom(0,s)}),Ol=Ft("s_sub",function(e,t){return e=v(e),e.lt(0)?t.s_add(v(0).sub(t.tactus.add(e))):t.s_add(t.tactus.sub(e))}),Bl=Ft("s_expand",function(e,t){return t.withTactus(n=>n.mul(v(e)))}),Pl=Ft("s_contract",function(e,t){return t.withTactus(n=>n.div(v(e)))});m.prototype.s_taperlist=function(e,t){const n=this;if(t=t-1,t===0)return n;const s=[],r=e>0;e=v(Math.abs(e));const o=n.tactus.sub(e.mul(v(t))).max(v(0));for(let i=0;i<t;++i)s.push(n.zoom(0,o.add(e.mul(v(i))).div(n.tactus)));return s.push(n),r&&s.reverse(),s};const zl=(e,t,n)=>n.s_taperlist(e,t),El=p("s_taper",function(e,t,n){const s=n.s_taperlist(e,t),r=X(...s);return r.tactus=s.reduce((o,i)=>o.add(i.tactus),v(0)),r},!0,!1,e=>e.stepJoin());m.prototype.s_tour=function(...e){return X(...[].concat(...e.map((t,n)=>[...e.slice(0,e.length-n),this,...e.slice(e.length-n)]),this,...e))};const xl=function(e,...t){return e.s_tour(...t)},jl=p("chop",function(e,t){const s=Array.from({length:e},(o,i)=>i).map(o=>({begin:o/e,end:(o+1)/e})),r=function(o){return et(s.map(i=>Object.assign({},o,i)))};return t.squeezeBind(r).setTactus(t.tactus.mul(e))}),$l=p("striate",function(e,t){const s=Array.from({length:e},(o,i)=>i).map(o=>({begin:o/e,end:(o+1)/e})),r=ht(...s);return t.set(r)._fast(e)}),an=function(e,t,n=.5){return t.speed(1/e*n).unit("c").slow(e)},un=p("slice",function(e,t,n){return e.innerBind(s=>t.outerBind(r=>n.outerBind(o=>{o=o instanceof Object?o:{s:o};const i=Array.isArray(s)?s[r]:r/s,a=Array.isArray(s)?s[r+1]:(r+1)/s;return nt({begin:i,end:a,_slices:s,...o})}))).setTactus(t.tactus)},!1),Rl=p("splice",function(e,t,n){const s=un(e,t,n);return new m(r=>{const o=r.controls._cps||1;return s.query(r).map(a=>a.withValue(l=>({speed:o/l._slices/a.whole.duration*(l.speed||1),unit:"c",...l})))}).setTactus(t.tactus)},!1),{loopAt:Fl,loopat:Jl}=p(["loopAt","loopat"],function(e,t){return new m(n=>an(e,t,n.controls._cps).query(n))}),Ll=p("fit",e=>e.withHaps((t,n)=>t.map(s=>s.withValue(r=>({...r,speed:(n.controls._cps||1)/s.whole.duration,unit:"c"}))))),{loopAtCps:Il,loopatcps:Wl}=p(["loopAtCps","loopatcps"],function(e,t,n){return an(e,n,t)}),Hl=e=>nt(1).withValue(()=>b(e())).innerJoin();let Se=e=>e<.5?1:1-(e-.5)/.5,ln=(e,t,n)=>{t=b(t),e=b(e),n=b(n);let s=t.fmap(o=>({gain:Se(o)})),r=t.fmap(o=>({gain:Se(1-o)}));return F(e.mul(s),n.mul(r))};m.prototype.xfade=function(e,t){return ln(this,e,t)};function Jt(e){let t=Array.isArray(e);e=t?e:[e];const n=e[0],s=i=>{let a;if(typeof i=="object"&&i.value!==void 0&&(a={...i},i=i.value,delete a.value),t&&Array.isArray(i)){const l=a||{};return i.forEach((h,u)=>{u<e.length&&(l[e[u]]=h)}),l}else return a?(a[n]=i,a):{[n]:i}},r=(...i)=>et(...i).withValue(s),o=function(...i){return i.length?this.set(r(...i)):this.fmap(s)};return m.prototype[n]=o,r}function c(e,...t){const n=Array.isArray(e)?e[0]:e;let s={};return s[n]=Jt(e),t.forEach(r=>{s[r]=s[n],m.prototype[r]=m.prototype[n]}),s}const{s:hn,sound:fn}=c(["s","n","gain"],"sound"),{source:pn,src:dn}=c("source","src"),{n:mn}=c("n"),{note:yn}=c(["note","n"]),{accelerate:gn}=c("accelerate"),{velocity:wn}=c("velocity"),{gain:bn}=c("gain"),{postgain:vn}=c("postgain"),{amp:_n}=c("amp"),{attack:kn,att:qn}=c("attack","att"),{fmh:An}=c(["fmh","fmi"],"fmh"),{fmi:Tn,fm:Cn}=c(["fmi","fmh"],"fm"),{fmenv:Mn}=c("fmenv"),{fmattack:Sn}=c("fmattack"),{fmdecay:Nn}=c("fmdecay"),{fmsustain:On}=c("fmsustain"),{fmrelease:Bn}=c("fmrelease"),{fmvelocity:Pn}=c("fmvelocity"),{bank:zn}=c("bank"),{analyze:En}=c("analyze"),{fft:xn}=c("fft"),{decay:jn,dec:$n}=c("decay","dec"),{sustain:Rn,sus:Fn}=c("sustain","sus"),{release:Jn,rel:Ln}=c("release","rel"),{hold:In}=c("hold"),{bandf:Wn,bpf:Hn,bp:Dn}=c(["bandf","bandq","bpenv"],"bpf","bp"),{bandq:Vn,bpq:Gn}=c("bandq","bpq"),{begin:Qn}=c("begin"),{end:Un}=c("end"),{loop:Kn}=c("loop"),{loopBegin:Xn,loopb:Yn}=c("loopBegin","loopb"),{loopEnd:Zn,loope:ts}=c("loopEnd","loope"),{crush:es}=c("crush"),{coarse:ns}=c("coarse"),{channels:ss,ch:rs}=c("channels","ch"),{phaserrate:os,phasr:is}=c("phaserrate","phasr"),{phaser:cs,ph:as}=c(["phaser","phaserdepth","phasercenter","phasersweep"],"ph"),{phasersweep:us,phs:ls}=c("phasersweep","phs"),{phasercenter:hs,phc:fs}=c("phasercenter","phc"),{phaserdepth:ps,phd:ds,phasdp:ms}=c("phaserdepth","phd","phasdp"),{channel:ys}=c("channel"),{cut:gs}=c("cut"),{cutoff:ws,ctf:bs,lpf:vs,lp:_s}=c(["cutoff","resonance","lpenv"],"ctf","lpf","lp"),{lpenv:ks,lpe:qs}=c("lpenv","lpe"),{hpenv:As,hpe:Ts}=c("hpenv","hpe"),{bpenv:Cs,bpe:Ms}=c("bpenv","bpe"),{lpattack:Ss,lpa:Ns}=c("lpattack","lpa"),{hpattack:Os,hpa:Bs}=c("hpattack","hpa"),{bpattack:Ps,bpa:zs}=c("bpattack","bpa"),{lpdecay:Es,lpd:xs}=c("lpdecay","lpd"),{hpdecay:js,hpd:$s}=c("hpdecay","hpd"),{bpdecay:Rs,bpd:Fs}=c("bpdecay","bpd"),{lpsustain:Js,lps:Ls}=c("lpsustain","lps"),{hpsustain:Is,hps:Ws}=c("hpsustain","hps"),{bpsustain:Hs,bps:Ds}=c("bpsustain","bps"),{lprelease:Vs,lpr:Gs}=c("lprelease","lpr"),{hprelease:Qs,hpr:Us}=c("hprelease","hpr"),{bprelease:Ks,bpr:Xs}=c("bprelease","bpr"),{ftype:Ys}=c("ftype"),{fanchor:Zs}=c("fanchor"),{vib:tr,vibrato:er,v:nr}=c(["vib","vibmod"],"vibrato","v"),{noise:sr}=c("noise"),{vibmod:rr,vmod:or}=c(["vibmod","vib"],"vmod"),{hcutoff:ir,hpf:cr,hp:ar}=c(["hcutoff","hresonance","hpenv"],"hpf","hp"),{hresonance:ur,hpq:lr}=c("hresonance","hpq"),{resonance:hr,lpq:fr}=c("resonance","lpq"),{djf:pr}=c("djf"),{delay:dr}=c(["delay","delaytime","delayfeedback"]),{delayfeedback:mr,delayfb:yr,dfb:gr}=c("delayfeedback","delayfb","dfb"),{delaytime:wr,delayt:br,dt:vr}=c("delaytime","delayt","dt"),{lock:_r}=c("lock"),{detune:kr,det:qr}=c("detune","det"),{unison:Ar}=c("unison"),{spread:Tr}=c("spread"),{dry:Cr}=c("dry"),{fadeTime:Mr,fadeOutTime:Sr}=c("fadeTime","fadeOutTime"),{fadeInTime:Nr}=c("fadeInTime"),{freq:Or}=c("freq"),{pattack:Br,patt:Pr}=c("pattack","patt"),{pdecay:zr,pdec:Er}=c("pdecay","pdec"),{psustain:xr,psus:jr}=c("psustain","psus"),{prelease:$r,prel:Rr}=c("prelease","prel"),{penv:Fr}=c("penv"),{pcurve:Jr}=c("pcurve"),{panchor:Lr}=c("panchor"),{gate:Ir,gat:Wr}=c("gate","gat"),{leslie:Hr}=c("leslie"),{lrate:Dr}=c("lrate"),{lsize:Vr}=c("lsize"),{activeLabel:Gr}=c("activeLabel"),{label:Qr}=c(["label","activeLabel"]),{degree:Ur}=c("degree"),{mtranspose:Kr}=c("mtranspose"),{ctranspose:Xr}=c("ctranspose"),{harmonic:Yr}=c("harmonic"),{stepsPerOctave:Zr}=c("stepsPerOctave"),{octaveR:to}=c("octaveR"),{nudge:eo}=c("nudge"),{octave:no}=c("octave"),{orbit:so}=c("orbit"),{overgain:ro}=c("overgain"),{overshape:oo}=c("overshape"),{pan:io}=c("pan"),{panspan:co}=c("panspan"),{pansplay:ao}=c("pansplay"),{panwidth:uo}=c("panwidth"),{panorient:lo}=c("panorient"),{rate:ho}=c("rate"),{slide:fo}=c("slide"),{semitone:po}=c("semitone"),{voice:mo}=c("voice"),{chord:yo}=c("chord"),{dictionary:go,dict:wo}=c("dictionary","dict"),{anchor:bo}=c("anchor"),{offset:vo}=c("offset"),{octaves:_o}=c("octaves"),{mode:ko}=c(["mode","anchor"]),{room:qo}=c(["room","size"]),{roomlp:Ao,rlp:To}=c("roomlp","rlp"),{roomdim:Co,rdim:Mo}=c("roomdim","rdim"),{roomfade:So,rfade:No}=c("roomfade","rfade"),{ir:Oo,iresponse:Bo}=c(["ir","i"],"iresponse"),{roomsize:Po,size:zo,sz:Eo,rsize:xo}=c("roomsize","size","sz","rsize"),{shape:jo}=c(["shape","shapevol"]),{distort:$o,dist:Ro}=c(["distort","distortvol"],"dist"),{compressor:Fo}=c(["compressor","compressorRatio","compressorKnee","compressorAttack","compressorRelease"]),{compressorKnee:Jo}=c("compressorKnee"),{compressorRatio:Lo}=c("compressorRatio"),{compressorAttack:Io}=c("compressorAttack"),{compressorRelease:Wo}=c("compressorRelease"),{speed:Ho}=c("speed"),{unit:Do}=c("unit"),{squiz:Vo}=c("squiz"),{vowel:Go}=c("vowel"),{waveloss:Qo}=c("waveloss"),{density:Dl}=c("density"),{expression:Uo}=c("expression"),{sustainpedal:Ko}=c("sustainpedal"),{tremolodepth:Xo,tremdp:Yo}=c("tremolodepth","tremdp"),{tremolorate:Zo,tremr:ti}=c("tremolorate","tremr"),{fshift:ei}=c("fshift"),{fshiftnote:ni}=c("fshiftnote"),{fshiftphase:si}=c("fshiftphase"),{triode:ri}=c("triode"),{krush:oi}=c("krush"),{kcutoff:ii}=c("kcutoff"),{octer:ci}=c("octer"),{octersub:ai}=c("octersub"),{octersubsub:ui}=c("octersubsub"),{ring:li}=c("ring"),{ringf:hi}=c("ringf"),{ringdf:fi}=c("ringdf"),{freeze:pi}=c("freeze"),{xsdelay:di}=c("xsdelay"),{tsdelay:mi}=c("tsdelay"),{real:yi}=c("real"),{imag:gi}=c("imag"),{enhance:wi}=c("enhance"),{partials:bi}=c("partials"),{comb:vi}=c("comb"),{smear:_i}=c("smear"),{scram:ki}=c("scram"),{binshift:qi}=c("binshift"),{hbrick:Ai}=c("hbrick"),{lbrick:Ti}=c("lbrick"),{midichan:Ci}=c("midichan"),{control:Mi}=c("control"),{ccn:Si}=c("ccn"),{ccv:Ni}=c("ccv"),{polyTouch:Oi}=c("polyTouch"),{midibend:Bi}=c("midibend"),{miditouch:Pi}=c("miditouch"),{ctlNum:zi}=c("ctlNum"),{frameRate:Ei}=c("frameRate"),{frames:xi}=c("frames"),{hours:ji}=c("hours"),{midicmd:$i}=c("midicmd"),{minutes:Ri}=c("minutes"),{progNum:Fi}=c("progNum"),{seconds:Ji}=c("seconds"),{songPtr:Li}=c("songPtr"),{uid:Ii}=c("uid"),{val:Wi}=c("val"),{cps:Hi}=c("cps"),{clip:Di,legato:Vi}=c("clip","legato"),{duration:Gi,dur:Qi}=c("duration","dur"),{zrand:Ui}=c("zrand"),{curve:Ki}=c("curve"),{deltaSlide:Xi}=c("deltaSlide"),{pitchJump:Yi}=c("pitchJump"),{pitchJumpTime:Zi}=c("pitchJumpTime"),{lfo:tc,repeatTime:ec}=c("lfo","repeatTime"),{znoise:nc}=c("znoise"),{zmod:sc}=c("zmod"),{zcrush:rc}=c("zcrush"),{zdelay:oc}=c("zdelay"),{tremolo:ic}=c("tremolo"),{zzfx:cc}=c("zzfx"),{color:ac,colour:uc}=c(["color","colour"]);let fe=(...e)=>e.reduce((t,n)=>Object.assign(t,{[n]:Jt(n)}),{});const lc=p("adsr",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,s,r,o]=e;return t.set({attack:n,decay:s,sustain:r,release:o})}),hc=p("ad",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,s=n]=e;return t.attack(n).decay(s)}),fc=p("ds",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,s=0]=e;return t.set({decay:n,sustain:s})}),pc=p("ar",(e,t)=>{e=Array.isArray(e)?e:[e];const[n,s=n]=e;return t.set({attack:n,release:s})}),Vl=Object.freeze(Object.defineProperty({__proto__:null,accelerate:gn,activeLabel:Gr,ad:hc,adsr:lc,amp:_n,analyze:En,anchor:bo,ar:pc,att:qn,attack:kn,bandf:Wn,bandq:Vn,bank:zn,begin:Qn,binshift:qi,bp:Dn,bpa:zs,bpattack:Ps,bpd:Fs,bpdecay:Rs,bpe:Ms,bpenv:Cs,bpf:Hn,bpq:Gn,bpr:Xs,bprelease:Ks,bps:Ds,bpsustain:Hs,ccn:Si,ccv:Ni,ch:rs,channel:ys,channels:ss,chord:yo,clip:Di,coarse:ns,color:ac,colour:uc,comb:vi,compressor:Fo,compressorAttack:Io,compressorKnee:Jo,compressorRatio:Lo,compressorRelease:Wo,control:Mi,cps:Hi,createParam:Jt,createParams:fe,crush:es,ctf:bs,ctlNum:zi,ctranspose:Xr,curve:Ki,cut:gs,cutoff:ws,dec:$n,decay:jn,degree:Ur,delay:dr,delayfb:yr,delayfeedback:mr,delayt:br,delaytime:wr,deltaSlide:Xi,density:Dl,det:qr,detune:kr,dfb:gr,dict:wo,dictionary:go,dist:Ro,distort:$o,djf:pr,dry:Cr,ds:fc,dt:vr,dur:Qi,duration:Gi,end:Un,enhance:wi,expression:Uo,fadeInTime:Nr,fadeOutTime:Sr,fadeTime:Mr,fanchor:Zs,fft:xn,fm:Cn,fmattack:Sn,fmdecay:Nn,fmenv:Mn,fmh:An,fmi:Tn,fmrelease:Bn,fmsustain:On,fmvelocity:Pn,frameRate:Ei,frames:xi,freeze:pi,freq:Or,fshift:ei,fshiftnote:ni,fshiftphase:si,ftype:Ys,gain:bn,gat:Wr,gate:Ir,harmonic:Yr,hbrick:Ai,hcutoff:ir,hold:In,hours:ji,hp:ar,hpa:Bs,hpattack:Os,hpd:$s,hpdecay:js,hpe:Ts,hpenv:As,hpf:cr,hpq:lr,hpr:Us,hprelease:Qs,hps:Ws,hpsustain:Is,hresonance:ur,imag:gi,ir:Oo,iresponse:Bo,kcutoff:ii,krush:oi,label:Qr,lbrick:Ti,legato:Vi,leslie:Hr,lfo:tc,lock:_r,loop:Kn,loopBegin:Xn,loopEnd:Zn,loopb:Yn,loope:ts,lp:_s,lpa:Ns,lpattack:Ss,lpd:xs,lpdecay:Es,lpe:qs,lpenv:ks,lpf:vs,lpq:fr,lpr:Gs,lprelease:Vs,lps:Ls,lpsustain:Js,lrate:Dr,lsize:Vr,midibend:Bi,midichan:Ci,midicmd:$i,miditouch:Pi,minutes:Ri,mode:ko,mtranspose:Kr,n:mn,noise:sr,note:yn,nudge:eo,octave:no,octaveR:to,octaves:_o,octer:ci,octersub:ai,octersubsub:ui,offset:vo,orbit:so,overgain:ro,overshape:oo,pan:io,panchor:Lr,panorient:lo,panspan:co,pansplay:ao,panwidth:uo,partials:bi,patt:Pr,pattack:Br,pcurve:Jr,pdec:Er,pdecay:zr,penv:Fr,ph:as,phasdp:ms,phaser:cs,phasercenter:hs,phaserdepth:ps,phaserrate:os,phasersweep:us,phasr:is,phc:fs,phd:ds,phs:ls,pitchJump:Yi,pitchJumpTime:Zi,polyTouch:Oi,postgain:vn,prel:Rr,prelease:$r,progNum:Fi,psus:jr,psustain:xr,rate:ho,rdim:Mo,real:yi,rel:Ln,release:Jn,repeatTime:ec,resonance:hr,rfade:No,ring:li,ringdf:fi,ringf:hi,rlp:To,room:qo,roomdim:Co,roomfade:So,roomlp:Ao,roomsize:Po,rsize:xo,s:hn,scram:ki,seconds:Ji,semitone:po,shape:jo,size:zo,slide:fo,smear:_i,songPtr:Li,sound:fn,source:pn,speed:Ho,spread:Tr,squiz:Vo,src:dn,stepsPerOctave:Zr,sus:Fn,sustain:Rn,sustainpedal:Ko,sz:Eo,tremdp:Yo,tremolo:ic,tremolodepth:Xo,tremolorate:Zo,tremr:ti,triode:ri,tsdelay:mi,uid:Ii,unison:Ar,unit:Do,v:nr,val:Wi,velocity:wn,vib:tr,vibmod:rr,vibrato:er,vmod:or,voice:mo,vowel:Go,waveloss:Qo,xsdelay:di,zcrush:rc,zdelay:oc,zmod:sc,znoise:nc,zrand:Ui,zzfx:cc},Symbol.toStringTag,{value:"Module"})),Gl=function(e,t){const[n,s]=e,[r,o]=t,[i,a]=se(s,r);return[[s,n-s],[re((l,h)=>l.concat(h),i,o),a]]},Ql=function(e,t){const[n,s]=e,[r,o]=t,[i,a]=se(n,o);return[[n,s-n],[re((h,u)=>h.concat(u),r,i),a]]},dc=function(e,t){const[n,s]=e;return Math.min(n,s)<=1?[e,t]:dc(...n>s?Gl(e,t):Ql(e,t))},mc=function(e,t){const n=e<0;e=Math.abs(e);const s=t-e,r=Array(e).fill([1]),o=Array(s).fill([0]),i=dc([e,s],[r,o]),a=ct(i[1][0]).concat(ct(i[1][1]));return n?a.map(l=>l===0?1:0):a},pe=function(e,t,n){const s=mc(e,t);return n?Je(s,-n):s},Ul=p("euclid",function(e,t,n){return n.struct(pe(e,t,0))}),{euclidrot:Kl,euclidRot:Xl}=p(["euclidrot","euclidRot"],function(e,t,n,s){return s.struct(pe(e,t,n))}),yc=function(e,t,n,s){if(e<1)return P;const o=pe(e,t,n).join("").split("1").slice(1).map(i=>[i.length+1,!0]);return s.struct(cn(...o))},Yl=p(["euclidLegato"],function(e,t,n){return yc(e,t,0,n)}),Zl=p(["euclidLegatoRot"],function(e,t,n,s){return yc(e,t,n,s)});function gc(e,t,n=.05,s=.1,r=.1,o=globalThis.setInterval,i=globalThis.clearInterval,a=!0){let l=0,h=0,u=10**4,f=.01;const y=S=>n=S(n);r=r||s/2;const d=()=>{const S=e(),B=S+s+r;for(h===0&&(h=S+f);h<B;)h=a?Math.round(h*u)/u:h,t(h,n,l,S),h+=n,l++};let _;const w=()=>{q(),d(),_=o(d,s*1e3)},q=()=>{_!==void 0&&i(_),_=void 0};return{setDuration:y,start:w,stop:()=>{l=0,h=0,q()},pause:()=>q(),duration:n,interval:s,getPhase:()=>h,minLatency:f}}function th(e){return new m(t=>[new $(void 0,t.span,e)])}const pt=e=>{const t=n=>[new $(void 0,n.span,e(n.span.midpoint()))];return new m(t)},de=pt(e=>1-e%1),wc=de.toBipolar(),Lt=pt(e=>e%1),bc=Lt.toBipolar(),me=pt(e=>Math.sin(Math.PI*2*e)),vc=me.fromBipolar(),eh=vc._early(v(1).div(4)),nh=me._early(v(1).div(4)),_c=pt(e=>Math.floor(e*2%2)),sh=_c.toBipolar(),rh=at(de,Lt),oh=at(wc,bc),kc=pt(yt),ih=e=>{const t=e<<13^e,n=t>>17^t;return n<<5^n},ch=e=>e-Math.trunc(e),ah=e=>ih(Math.trunc(ch(e/300)*536870912)),uh=e=>e%536870912/536870912,Qt=e=>Math.abs(uh(ah(e))),lh=e=>Lt.range(0,e).floor().segment(e),Y=pt(Qt),hh=Y.toBipolar(),ye=e=>Y.fmap(t=>t<e),fh=e=>b(e).fmap(ye).innerJoin(),ph=ye(.5),qc=e=>Y.fmap(t=>Math.trunc(t*e)),dh=e=>b(e).fmap(qc).innerJoin(),st=function(e,t,n=!0){const s=Array.isArray(e),r=Object.keys(e).length;return e=Qe(e,b),r===0?P:t.fmap(o=>{let i=o;return s&&(i=n?Math.round(i)%r:He(Math.round(i),0,e.length-1)),e[i]})},Ac=function(e,t){return Array.isArray(t)&&([t,e]=[e,t]),mh(e,t)},mh=p("pick",function(e,t){return st(e,t,!1).innerJoin()}),Tc=p("pickmod",function(e,t){return st(e,t,!0).innerJoin()}),yh=p("pickF",function(e,t,n){return n.apply(Ac(e,t))}),gh=p("pickmodF",function(e,t,n){return n.apply(Tc(e,t))}),wh=p("pickOut",function(e,t){return st(e,t,!1).outerJoin()}),bh=p("pickmodOut",function(e,t){return st(e,t,!0).outerJoin()}),vh=p("pickRestart",function(e,t){return st(e,t,!1).restartJoin()}),_h=p("pickmodRestart",function(e,t){return st(e,t,!0).restartJoin()}),kh=p("pickReset",function(e,t){return st(e,t,!1).resetJoin()}),qh=p("pickmodReset",function(e,t){return st(e,t,!0).resetJoin()}),{inhabit:Ah,pickSqueeze:Th}=p(["inhabit","pickSqueeze"],function(e,t){return st(e,t,!1).squeezeJoin()}),{inhabitmod:Ch,pickmodSqueeze:Mh}=p(["inhabitmod","pickmodSqueeze"],function(e,t){return st(e,t,!0).squeezeJoin()}),Sh=(e,t)=>(t=t.map(b),t.length==0?P:e.fmap(n=>{const s=Nt(Math.round(n),t.length);return t[s]}).squeezeJoin()),ge=(e,t)=>(t=t.map(b),t.length==0?P:e.range(0,t.length).fmap(n=>{const s=Math.min(Math.max(Math.floor(n),0),t.length-1);return t[s]})),It=(e,t)=>ge(e,t).outerJoin(),Cc=(e,t)=>ge(e,t).innerJoin(),Nh=(...e)=>It(Y,e);m.prototype.choose=function(...e){return It(this,e)};m.prototype.choose2=function(...e){return It(this.fromBipolar(),e)};const Mc=(...e)=>Cc(Y.segment(1),e),Oh=Mc,Sc=function(e,...t){const n=t.map(a=>b(a[0])),s=[];let r=0;for(const a of t)r+=a[1],s.push(r);const o=r,i=function(a){const l=a*o;return n[s.findIndex(h=>h>l,s)]};return e.fmap(i)},Bh=(...e)=>Sc(...e).outerJoin(),Ph=(...e)=>Bh(Y,...e),Nc=(...e)=>Sc(Y.segment(1),...e).innerJoin(),zh=Nc,Oc=e=>{const t=e.fmap(Math.floor),n=e.fmap(o=>Math.floor(o)+1),s=o=>6*o**5-15*o**4+10*o**3,r=o=>i=>a=>i+s(o)*(a-i);return e.sub(t).fmap(r).appBoth(t.fmap(Qt)).appBoth(n.fmap(Qt))},Eh=Oc(kc.fmap(e=>Number(e))),xh=p("degradeByWith",(e,t,n)=>n.fmap(s=>r=>s).appLeft(e.filterValues(s=>s>t))),jh=p("degradeBy",function(e,t){return t._degradeByWith(Y,e)}),$h=p("degrade",e=>e._degradeBy(.5)),Rh=p("undegradeBy",function(e,t){return t._degradeByWith(Y.fmap(n=>1-n),e)}),Fh=p("undegrade",e=>e._undegradeBy(.5)),Jh=p("sometimesBy",function(e,t,n){return b(e).fmap(s=>F(n._degradeBy(s),t(n._undegradeBy(1-s)))).innerJoin()}),Lh=p("sometimes",function(e,t){return t._sometimesBy(.5,e)}),Ih=p("someCyclesBy",function(e,t,n){return b(e).fmap(s=>F(n._degradeByWith(Y._segment(1),s),t(n._degradeByWith(Y.fmap(r=>1-r)._segment(1),1-s)))).innerJoin()}),Wh=p("someCycles",function(e,t){return t._someCyclesBy(.5,e)}),Hh=p("often",function(e,t){return t.sometimesBy(.75,e)}),Dh=p("rarely",function(e,t){return t.sometimesBy(.25,e)}),Vh=p("almostNever",function(e,t){return t.sometimesBy(.1,e)}),Gh=p("almostAlways",function(e,t){return t.sometimesBy(.9,e)}),Qh=p("never",function(e,t){return t}),Uh=p("always",function(e,t){return e(t)});let jt;try{jt=window?.speechSynthesis}catch{console.warn("cannot use window: not in browser?")}let Ne=jt?.getVoices();function Kh(e,t,n){jt.cancel();const s=new SpeechSynthesisUtterance(e);s.lang=t,Ne=jt.getVoices();const r=Ne.filter(o=>o.lang.includes(t));typeof n=="number"?s.voice=r[n%r.length]:typeof n=="string"&&(s.voice=r.find(o=>o.name===o)),speechSynthesis.speak(s)}const Xh=p("speak",function(e,t,n){return n.onTrigger((s,r)=>{Kh(r.value,e,t)})}),Bc=async(...e)=>{const t=await Promise.allSettled(e),n=t.filter(s=>s.status==="fulfilled").map(s=>s.value);return t.forEach((s,r)=>{s.status==="rejected"&&console.warn(`evalScope: module with index ${r} could not be loaded:`,s.reason)}),n.forEach(s=>{Object.entries(s).forEach(([r,o])=>{globalThis[r]=o})}),n};function Yh(e,t={}){const{wrapExpression:n=!0,wrapAsync:s=!0}=t;n&&(e=`{${e}}`),s&&(e=`(async ()=>${e})()`);const r=`"use strict";return (${e})`;return Function(r)()}const Pc=async(e,t)=>{let n={};if(t){const o=t(e);e=o.output,n=o}return{mode:"javascript",pattern:await Yh(e,{wrapExpression:!!t}),meta:n}};class Zh{constructor({onTrigger:t,onToggle:n,getTime:s}){this.started=!1,this.cps=.5,this.lastTick=0,this.getTime=s,this.time_at_last_tick_message=0,this.num_cycles_at_cps_change=0,this.onToggle=n,this.latency=.1,this.cycle=0,this.id=Math.round(Date.now()*Math.random()),this.worker_time_dif,this.worker=new SharedWorker(new URL("/tools/strudel/assets/clockworker-OodvW4tn.js",import.meta.url)),this.worker.port.start(),this.channel=new BroadcastChannel("strudeltick");let r=0;const o=20,i=10**3,a=(u,f,y)=>{const d=s()-(u+f)+y;if(this.worker_time_dif==null)this.worker_time_dif=d;else{const w=Math.round((this.worker_time_dif*r+d*1)/(r+1)*i)/i;w!=this.worker_time_dif&&(r=4),this.worker_time_dif=w}r=Math.min(r+1,o)},l=u=>{const{num_cycles_at_cps_change:f,cps:y,num_seconds_at_cps_change:d,num_seconds_since_cps_change:_,begin:w,end:q,tickdeadline:k,cycle:N}=u;this.cps=y,this.cycle=N,a(d,_,k),h(w,q,f,d),this.time_at_last_tick_message=this.getTime()},h=(u,f,y,d)=>{if(this.started===!1)return;this.pattern.queryArc(u,f,{_cps:this.cps}).forEach(w=>{if(w.hasOnset()){const q=(w.whole.begin-y)/this.cps+d+this.latency+this.worker_time_dif,k=w.duration/this.cps;t?.(w,0,k,this.cps,q)}})};this.channel.onmessage=u=>{if(!this.started)return;const{payload:f,type:y}=u.data;switch(y){case"tick":l(f)}}}sendMessage(t,n){this.worker.port.postMessage({type:t,payload:n,id:this.id})}now(){const t=(this.getTime()-this.time_at_last_tick_message)*this.cps;return this.cycle+t}setCps(t=1){this.sendMessage("cpschange",{cps:t})}setCycle(t){this.sendMessage("setcycle",{cycle:t})}setStarted(t){this.sendMessage("toggle",{started:t}),this.started=t,this.onToggle?.(t)}start(){W("[cyclist] start"),this.setStarted(!0)}stop(){this.worker_time_dif=null,W("[cyclist] stop"),this.setStarted(!1)}setPattern(t,n=!1){this.pattern=t,n&&!this.started&&this.start()}log(t,n,s){const r=s.filter(o=>o.hasOnset());console.log(`${t.toFixed(4)} - ${n.toFixed(4)} ${Array(r.length).fill("I").join("")}`)}}class zc{constructor({interval:t,onTrigger:n,onToggle:s,onError:r,getTime:o,latency:i=.1,setInterval:a,clearInterval:l}){this.started=!1,this.cps=.5,this.num_ticks_since_cps_change=0,this.lastTick=0,this.lastBegin=0,this.lastEnd=0,this.getTime=o,this.num_cycles_at_cps_change=0,this.seconds_at_cps_change,this.onToggle=s,this.latency=i,this.clock=gc(o,(h,u,f,y)=>{this.num_ticks_since_cps_change===0&&(this.num_cycles_at_cps_change=this.lastEnd,this.seconds_at_cps_change=h),this.num_ticks_since_cps_change++;const _=this.num_ticks_since_cps_change*u*this.cps;try{const w=this.lastEnd;this.lastBegin=w;const q=this.num_cycles_at_cps_change+_;if(this.lastEnd=q,this.lastTick=h,h<y){console.log("skip query: too late");return}this.pattern.queryArc(w,q,{_cps:this.cps}).forEach(N=>{if(N.hasOnset()){const E=(N.whole.begin-this.num_cycles_at_cps_change)/this.cps+this.seconds_at_cps_change+i,S=N.duration/this.cps,B=E-h;n?.(N,B,S,this.cps,E)}})}catch(w){W(`[cyclist] error: ${w.message}`),r?.(w)}},t,.1,.1,a,l)}now(){if(!this.started)return 0;const t=this.getTime()-this.lastTick-this.clock.duration;return this.lastBegin+t*this.cps}setStarted(t){this.started=t,this.onToggle?.(t)}start(){if(this.num_ticks_since_cps_change=0,this.num_cycles_at_cps_change=0,!this.pattern)throw new Error("Scheduler: no pattern set! call .setPattern first.");W("[cyclist] start"),this.clock.start(),this.setStarted(!0)}pause(){W("[cyclist] pause"),this.clock.pause(),this.setStarted(!1)}stop(){W("[cyclist] stop"),this.clock.stop(),this.lastEnd=0,this.setStarted(!1)}setPattern(t,n=!1){this.pattern=t,n&&!this.started&&this.start()}setCps(t=.5){this.cps!==t&&(this.cps=t,this.num_ticks_since_cps_change=0)}log(t,n,s){const r=s.filter(o=>o.hasOnset());console.log(`${t.toFixed(4)} - ${n.toFixed(4)} ${Array(r.length).fill("I").join("")}`)}}let Ut;function Kt(){if(!Ut)throw new Error("no time set! use setTime to define a time source");return Ut()}function Ec(e){Ut=e}function tf({defaultOutput:e,onEvalError:t,beforeEval:n,afterEval:s,getTime:r,transpiler:o,onToggle:i,editPattern:a,onUpdateState:l,sync:h=!1,setInterval:u,clearInterval:f}){const y={schedulerError:void 0,evalError:void 0,code:"// LOADING",activeCode:"// LOADING",pattern:void 0,miniLocations:[],widgets:[],pending:!1,started:!1},d=C=>{Object.assign(y,C),y.isDirty=y.code!==y.activeCode,y.error=y.evalError||y.schedulerError,l?.(y)},_={onTrigger:xc({defaultOutput:e,getTime:r}),getTime:r,onToggle:C=>{d({started:C}),i?.(C)},setInterval:u,clearInterval:f},w=h&&typeof SharedWorker<"u"?new Zh(_):new zc(_);let q={},k=0,N;const E=function(){return q={},k=0,N=void 0,P},S=(C,M=!0)=>{C=a?.(C)||C,w.setPattern(C,M)};Ec(()=>w.now());const B=()=>w.stop(),J=()=>w.start(),Z=()=>w.pause(),H=()=>w.toggle(),I=C=>w.setCps(C),T=C=>w.setCps(C/60),rt=function(C){return N=C,P},L=()=>{m.prototype.p=function(M){return M.startsWith("_")||M.endsWith("_")?P:(M==="$"&&(M=`$${k}`,k++),q[M]=this,this)},m.prototype.q=function(M){return P};try{for(let M=1;M<10;++M)Object.defineProperty(m.prototype,`d${M}`,{get(){return this.p(M)},configurable:!0}),Object.defineProperty(m.prototype,`p${M}`,{get(){return this.p(M)},configurable:!0}),m.prototype[`q${M}`]=P}catch(M){console.warn("injectPatternMethods: error:",M)}const C=p("cpm",function(M,V){return V._fast(M/60/w.cps)});return Bc({all:rt,hush:E,cpm:C,setCps:I,setcps:I,setCpm:T,setcpm:T})};return{scheduler:w,evaluate:async(C,M=!0,V=!0)=>{if(!C)throw new Error("no code to evaluate");try{d({code:C,pending:!0}),await L(),await n?.({code:C}),V&&E();let{pattern:j,meta:lt}=await Pc(C,o);if(Object.keys(q).length&&(j=F(...Object.values(q))),N&&(j=N(j)),!oe(j)){const Ot=`got "${typeof evaluated}" instead of pattern`;throw new Error(Ot+(typeof evaluated=="function"?", did you forget to call a function?":"."))}return W("[eval] code updated"),S(j,M),d({miniLocations:lt?.miniLocations||[],widgets:lt?.widgets||[],activeCode:C,pattern:j,evalError:void 0,schedulerError:void 0,pending:!1}),s?.({code:C,pattern:j,meta:lt}),j}catch(j){W(`[eval] error: ${j.message}`,"error"),console.error(j),d({evalError:j,pending:!1}),t?.(j)}},start:J,stop:B,pause:Z,setCps:I,setPattern:S,setCode:C=>d({code:C}),toggle:H,state:y}}const xc=({getTime:e,defaultOutput:t})=>async(n,s,r,o,i)=>{try{(!n.context.onTrigger||!n.context.dominantTrigger)&&await t(n,s,r,o,i),n.context.onTrigger&&await n.context.onTrigger(e()+s,n,e(),o,i)}catch(a){W(`[cyclist] error: ${a.message}`,"error")}},ef=function(e,t={}){const n=document.getElementById("code"),s="background-image:url("+e+");background-size:contain;";n.style=s;const{className:r}=n,o=(l,h)=>{({style:()=>n.style=s+";"+h,className:()=>n.className=h+" "+r})[l]()},i=Object.entries(t).filter(([l,h])=>typeof h=="function");Object.entries(t).filter(([l,h])=>typeof h=="string").forEach(([l,h])=>o(l,h)),i.length},nf=()=>{const e=document.getElementById("code");e&&(e.style="")};W("🌀 @strudel/core loaded 🌀");globalThis._strudelLoaded&&console.warn(`@strudel/core was loaded more than once...
This might happen when you have multiple versions of strudel installed. 
Please check with "npm ls @strudel/core".`);globalThis._strudelLoaded=!0;const df=Object.freeze(Object.defineProperty({__proto__:null,Cyclist:zc,Fraction:v,Hap:$,Pattern:m,State:bt,TimeSpan:R,__chooseWith:ge,_brandBy:ye,_fitslice:sn,_irand:qc,_match:rn,_mod:Nt,_polymeterListSteps:le,_retime:Vt,_slices:Gt,accelerate:gn,activeLabel:Gr,ad:hc,add:Wa,adsr:lc,almostAlways:Gh,almostNever:Vh,always:Uh,amp:_n,analyze:En,anchor:bo,and:au,apply:Ru,ar:pc,arrange:ja,att:qn,attack:kn,backgroundImage:ef,band:Ua,bandf:Wn,bandq:Vn,bank:zn,base64ToUnicode:Ge,begin:Qn,binshift:qi,bjork:mc,blshift:Ya,bor:Ka,bp:Dn,bpa:zs,bpattack:Ps,bpd:Fs,bpdecay:Rs,bpe:Ms,bpenv:Cs,bpf:Hn,bpq:Gn,bpr:Xs,bprelease:Ks,bps:Ds,bpsustain:Hs,brak:Yu,brand:ph,brandBy:fh,brshift:Za,bxor:Xa,bypass:kl,cat:Ze,ccn:Si,ccv:Ni,ceil:pu,ch:rs,channel:ys,channels:ss,choose:Nh,chooseCycles:Mc,chooseInWith:Cc,chooseWith:It,chop:jl,chord:yo,chunk:ml,chunkBack:wl,chunkback:bl,clamp:He,cleanupUi:nf,clip:Di,coarse:ns,code2hash:Ta,color:ac,colour:uc,comb:vi,compose:pa,compress:vu,compressSpan:_u,compressor:Fo,compressorAttack:Io,compressorKnee:Jo,compressorRatio:Lo,compressorRelease:Wo,compressspan:ku,constant:da,control:Mi,controls:Vl,cosine:eh,cosine2:nh,cpm:Fu,cps:Hi,createClock:gc,createParam:Jt,createParams:fe,crush:es,ctf:bs,ctlNum:zi,ctranspose:Xr,curry:A,curve:Ki,cut:gs,cutoff:ws,dec:$n,decay:jn,degrade:$h,degradeBy:jh,degradeByWith:xh,degree:Ur,delay:dr,delayfb:yr,delayfeedback:mr,delayt:br,delaytime:wr,deltaSlide:Xi,det:qr,detune:kr,dfb:gr,dict:wo,dictionary:go,dist:Ro,distort:$o,div:Va,djf:pr,drawLine:Ue,dry:Cr,ds:fc,dt:vr,dur:Qi,duration:Gi,early:Ju,echo:ul,echoWith:ol,echowith:il,end:Un,enhance:wi,eq:ru,eqt:ou,euclid:Ul,euclidLegato:Yl,euclidLegatoRot:Zl,euclidRot:Xl,euclidrot:Kl,evalScope:Bc,evaluate:Pc,every:$u,expression:Uo,fadeInTime:Nr,fadeOutTime:Sr,fadeTime:Mr,fanchor:Zs,fast:Nu,fastChunk:_l,fastGap:qu,fastcat:at,fastchunk:vl,fastgap:Au,fft:xn,firstOf:ju,fit:Ll,flatten:ct,floor:fu,fm:Cn,fmattack:Sn,fmdecay:Nn,fmenv:Mn,fmh:An,fmi:Tn,fmrelease:Bn,fmsustain:On,fmvelocity:Pn,focus:Tu,focusSpan:Cu,focusspan:Mu,fractionalArgs:ma,frameRate:Ei,frames:xi,freeze:pi,freq:Or,freqToMidi:Zt,fromBipolar:mu,fshift:ei,fshiftnote:ni,fshiftphase:si,ftype:Ys,func:lu,gain:bn,gap:kt,gat:Wr,gate:Ir,getEventOffsetMs:aa,getFreq:$e,getFrequency:Fe,getPlayableNoteValue:fa,getSoundIndex:ha,getTime:Kt,getTrigger:xc,gt:eu,gte:su,harmonic:Yr,hash2code:Ca,hbrick:Ai,hcutoff:ir,hold:In,hours:ji,hp:ar,hpa:Bs,hpattack:Os,hpd:$s,hpdecay:js,hpe:Ts,hpenv:As,hpf:cr,hpq:lr,hpr:Us,hprelease:Qs,hps:Ws,hpsustain:Is,hresonance:ur,hsl:Tl,hsla:Al,hurry:Ou,id:yt,imag:gi,inhabit:Ah,inhabitmod:Ch,inside:zu,inv:Uu,invert:Qu,ir:Oo,irand:dh,iresponse:Bo,isNote:$t,isNoteWithOctave:ra,isPattern:oe,isaw:de,isaw2:wc,iter:hl,iterBack:fl,iterback:pl,jux:rl,juxBy:nl,juxby:sl,kcutoff:ii,keep:La,keepif:Ia,krush:oi,label:Qr,lastOf:xu,late:en,lbrick:Ti,legato:Vi,leslie:Hr,lfo:tc,linger:Hu,listRange:te,lock:_r,logKey:Yt,logger:W,loop:Kn,loopAt:Fl,loopAtCps:Il,loopBegin:Xn,loopEnd:Zn,loopat:Jl,loopatcps:Wl,loopb:Yn,loope:ts,lp:_s,lpa:Ns,lpattack:Ss,lpd:xs,lpdecay:Es,lpe:qs,lpenv:ks,lpf:vs,lpq:fr,lpr:Gs,lprelease:Vs,lps:Ls,lpsustain:Js,lrate:Dr,lsize:Vr,lt:tu,lte:nu,mapArgs:ne,mask:$a,midi2note:la,midiToFreq:ft,midibend:Bi,midichan:Ci,midicmd:$i,miditouch:Pi,minutes:Ri,mod:Ga,mode:ko,mtranspose:Kr,mul:Da,n:mn,nanFallback:Re,ne:iu,net:cu,never:Qh,noise:sr,note:yn,noteToMidi:_t,nothing:gt,nudge:eo,numeralArgs:K,objectMap:Qe,octave:no,octaveR:to,octaves:_o,octer:ci,octersub:ai,octersubsub:ui,off:Xu,offset:vo,often:Hh,or:uu,orbit:so,outside:Eu,overgain:ro,overshape:oo,pairs:We,palindrome:el,pan:io,panchor:Lr,panorient:lo,panspan:co,pansplay:ao,panwidth:uo,parseFractional:Ie,parseNumeral:ee,partials:bi,patt:Pr,pattack:Br,pcurve:Jr,pdec:Er,pdecay:zr,penv:Fr,perlin:Eh,perlinWith:Oc,ph:as,phasdp:ms,phaser:cs,phasercenter:hs,phaserdepth:ps,phaserrate:os,phasersweep:us,phasr:is,phc:fs,phd:ds,phs:ls,pick:Ac,pickF:yh,pickOut:wh,pickReset:kh,pickRestart:vh,pickSqueeze:Th,pickmod:Tc,pickmodF:gh,pickmodOut:bh,pickmodReset:qh,pickmodRestart:_h,pickmodSqueeze:Mh,pipe:Le,pitchJump:Yi,pitchJumpTime:Zi,ply:Su,pm:Ea,polyTouch:Oi,polyrhythm:Pa,postgain:vn,pow:Qa,pr:za,prel:Rr,prelease:$r,press:tl,pressBy:Zu,progNum:Fi,psus:jr,psustain:xr,pure:nt,rand:Y,rand2:hh,randcat:Oh,range:yu,range2:wu,rangex:gu,rarely:Dh,rate:ho,ratio:bu,rdim:Mo,real:yi,ref:Hl,register:p,reify:b,rel:Ln,release:Jn,removeUndefineds:Rt,repeatCycles:dl,repeatTime:ec,repl:tf,resonance:hr,rev:nn,rfade:No,ribbon:ql,ring:li,ringdf:fi,ringf:hi,rlp:To,room:qo,roomdim:Co,roomfade:So,roomlp:Ao,roomsize:Po,rotate:Je,round:hu,rsize:xo,run:lh,s:hn,s_add:Nl,s_alt:Sl,s_cat:X,s_contract:Pl,s_expand:Bl,s_polymeter:he,s_polymeterSteps:on,s_sub:Ol,s_taper:El,s_taperlist:zl,s_tour:xl,saw:Lt,saw2:bc,scram:ki,seconds:Ji,segment:Du,semitone:po,seq:tn,sequence:et,set:Ja,setStringParser:Sa,setTime:Ec,shape:jo,signal:pt,silence:P,sine:vc,sine2:me,size:zo,slice:un,slide:fo,slow:Bu,slowChunk:gl,slowcat:ht,slowcatPrime:ce,slowchunk:yl,smear:_i,sol2note:ka,someCycles:Wh,someCyclesBy:Ih,sometimes:Lh,sometimesBy:Jh,songPtr:Li,sound:fn,source:pn,sparsity:Pu,speak:Xh,speed:Ho,splice:Rl,splitAt:se,spread:Tr,square:_c,square2:sh,squeeze:Sh,squiz:Vo,src:dn,stack:F,stackBy:xa,stackCentre:Ye,stackLeft:Ke,stackRight:Xe,steady:th,steps:Cl,stepsPerOctave:Zr,striate:$l,struct:Ra,stut:ll,stutWith:cl,stutwith:al,sub:Ha,superimpose:Fa,sus:Fn,sustain:Rn,sustainpedal:Ko,swing:Gu,swingBy:Vu,sz:Eo,time:kc,timeCat:cn,timecat:Ml,toBipolar:du,tokenizeNote:je,tremdp:Yo,tremolo:ic,tremolodepth:Xo,tremolorate:Zo,tremr:ti,tri:rh,tri2:oh,triode:ri,tsdelay:mi,uid:Ii,undegrade:Fh,undegradeBy:Rh,unicodeToBase64:Ve,uniq:qa,uniqsort:Aa,uniqsortr:De,unison:Ar,unit:Do,v:nr,val:Wi,valueToMidi:ca,velocity:wn,vib:tr,vibmod:rr,vibrato:er,vmod:or,voice:mo,vowel:Go,waveloss:Qo,wchoose:Ph,wchooseCycles:Nc,when:Ku,wrandcat:zh,xfade:ln,xsdelay:di,zcrush:rc,zdelay:oc,zipWith:re,zmod:sc,znoise:nc,zoom:Lu,zoomArc:Iu,zoomarc:Wu,zrand:Ui,zzfx:cc},Symbol.toStringTag,{value:"Module"})),Wt=(e="test-canvas",t)=>{let{contextType:n="2d",pixelated:s=!1,pixelRatio:r=window.devicePixelRatio}=t||{},o=document.querySelector("#"+e);if(!o){o=document.createElement("canvas"),o.id=e,o.width=window.innerWidth*r,o.height=window.innerHeight*r,o.style="pointer-events:none;width:100%;height:100%;position:fixed;top:0;left:0",s&&(o.style.imageRendering="pixelated"),document.body.prepend(o);let i;window.addEventListener("resize",()=>{i&&clearTimeout(i),i=setTimeout(()=>{o.width=window.innerWidth*r,o.height=window.innerHeight*r},200)})}return o.getContext(n)};let wt={};function jc(e){wt[e]!==void 0&&(cancelAnimationFrame(wt[e]),delete wt[e])}function sf(){Object.keys(wt).forEach(e=>jc(e))}let it={};m.prototype.draw=function(e,t){if(typeof window>"u")return this;let{id:n=1,lookbehind:s=0,lookahead:r=0}=t,o=Math.max(Kt(),0);jc(n),s=Math.abs(s),it[n]=(it[n]||[]).filter(h=>!h.isInFuture(o));let i=this.queryArc(o,o+r).filter(h=>h.hasOnset());it[n]=it[n].concat(i);let a;const l=()=>{const h=Kt(),u=h+r;it[n]=it[n].filter(d=>d.isInNearPast(s,h));let f=Math.max(a||u,u-1/10);const y=this.queryArc(f,u).filter(d=>d.hasOnset());it[n]=it[n].concat(y),a=u,e(it[n],h,u,this),wt[n]=requestAnimationFrame(l)};return wt[n]=requestAnimationFrame(l),this};const mf=(e=!0)=>{const t=Wt();e&&t.clearRect(0,0,t.canvas.width,t.canvas.width),sf(),window.strudelScheduler&&clearInterval(window.strudelScheduler)};m.prototype.onPaint=function(){return console.warn("[draw] onPaint was not overloaded. Some drawings might not work"),this};class rf{constructor(t,n){this.onFrame=t,this.onError=n}start(){const t=this;let n=requestAnimationFrame(function s(r){try{t.onFrame(r)}catch(o){t.onError(o)}n=requestAnimationFrame(s)});t.cancel=()=>{cancelAnimationFrame(n)}}stop(){this.cancel&&this.cancel()}}class yf{constructor(t,n){this.visibleHaps=[],this.lastFrame=null,this.drawTime=n,this.framer=new rf(()=>{if(!this.scheduler){console.warn("Drawer: no scheduler");return}const s=Math.abs(this.drawTime[0]),r=this.drawTime[1],o=this.scheduler.now()+r;if(this.lastFrame===null){this.lastFrame=o;return}const i=this.scheduler.pattern.queryArc(Math.max(this.lastFrame,o-1/10),o);this.lastFrame=o,this.visibleHaps=(this.visibleHaps||[]).filter(l=>l.endClipped>=o-s-r).concat(i.filter(l=>l.hasOnset()));const a=o-r;t(this.visibleHaps,a,this)},s=>{console.warn("draw error",s)})}setDrawTime(t){this.drawTime=t}invalidate(t=this.scheduler,n){if(!t)return;n=n??t.now(),this.scheduler=t;let[s,r]=this.drawTime;const[o,i]=[Math.max(n,0),n+r+.1];this.visibleHaps=this.visibleHaps.filter(l=>l.whole.begin<n);const a=t.pattern.queryArc(o,i);this.visibleHaps=this.visibleHaps.concat(a)}start(t){this.scheduler=t,this.invalidate(),this.framer.start()}stop(){this.framer&&this.framer.stop()}}function gf(e){return typeof window>"u"?"#fff":getComputedStyle(document.documentElement).getPropertyValue(e)}let $c={};function vt(){return $c}function wf(e){$c=e}let Oe="#22222210";m.prototype.animate=function({callback:e,sync:t=!1,smear:n=.5}={}){window.frame&&cancelAnimationFrame(window.frame);const s=Wt();let{clientWidth:r,clientHeight:o}=s.canvas;r*=window.devicePixelRatio,o*=window.devicePixelRatio;let i=n===0?"99":Number((1-n)*100).toFixed(0);i=i.length===1?`0${i}`:i,Oe=`#200010${i}`;const a=l=>{let h;l=Math.round(l),h=this.slow(1e3).queryArc(l,l),s.fillStyle=Oe,s.fillRect(0,0,r,o),h.forEach(u=>{let{x:f,y,w:d,h:_,s:w,r:q,angle:k=0,fill:N="darkseagreen"}=u.value;if(d*=r,_*=o,q!==void 0&&k!==void 0){const S=k*2*Math.PI,[B,J]=[(r-d)/2,(o-_)/2];f=B+Math.cos(S)*q*B,y=J+Math.sin(S)*q*J}else f*=r-d,y*=o-_;const E={...u.value,x:f,y,w:d,h:_};s.fillStyle=N,w==="rect"?s.fillRect(f,y,d,_):w==="ellipse"&&(s.beginPath(),s.ellipse(f+d/2,y+_/2,d/2,_/2,0,0,2*Math.PI),s.fill()),e&&e(s,E,u)}),window.frame=requestAnimationFrame(a)};return window.frame=requestAnimationFrame(a),P};const{x:Rc,y:bf,w:vf,h:_f,angle:kf,r:qf,fill:Af,smear:Tf}=fe("x","y","w","h","angle","r","fill","smear"),Cf=p("rescale",function(e,t){return t.mul(Rc(e).w(e).y(e).h(e))}),Mf=p("moveXY",function(e,t,n){return n.add(Rc(e).y(t))}),Sf=p("zoomIn",function(e,t){const n=nt(1).sub(e).div(2);return t.rescale(e).move(n,n)}),Mt=(e,t,n)=>e*(n-t)+t,Be=e=>{let{value:t}=e;typeof e.value!="object"&&(t={value:t});let{note:n,n:s,freq:r,s:o}=t;if(r)return Zt(r);if(n=n??s,typeof n=="string")try{return _t(n)}catch{return 0}return typeof n=="number"?n:o?"_"+o:t};m.prototype.pianoroll=function(e={}){let{cycles:t=4,playhead:n=.5,overscan:s=0,hideNegative:r=!1,ctx:o=Wt(),id:i=1}=e,a=-t*n,l=t*(1-n);const h=(u,f)=>(!r||u.whole.begin>=0)&&u.isWithinTime(f+a,f+l);return this.draw((u,f)=>{we({...e,time:f,ctx:o,haps:u.filter(y=>h(y,f))})},{lookbehind:a-s,lookahead:l+s,id:i}),this};function we({time:e,haps:t,cycles:n=4,playhead:s=.5,flipTime:r=0,flipValues:o=0,hideNegative:i=!1,inactive:a=vt().foreground,active:l=vt().foreground,background:h="transparent",smear:u=0,playheadColor:f="white",minMidi:y=10,maxMidi:d=90,autorange:_=0,timeframe:w,fold:q=0,vertical:k=0,labels:N=!1,fill:E=1,fillActive:S=!1,strokeActive:B=!0,stroke:J,hideInactive:Z=0,colorizeInactive:H=1,fontFamily:I,ctx:T,id:rt}={}){const L=T.canvas.width,tt=T.canvas.height;let ut=-n*s,C=n*(1-s);rt&&(t=t.filter(x=>x.hasTag(rt))),w&&(console.warn("timeframe is deprecated! use from/to instead"),ut=0,C=w);const M=k?tt:L,V=k?L:tt;let j=k?[M,0]:[0,M];const lt=C-ut,Ot=k?[0,V]:[V,0];let Bt=d-y+1,dt=V/Bt,Pt=[];r&&j.reverse(),o&&Ot.reverse();const{min:Jc,max:Lc,values:Ic}=t.reduce(({min:x,max:G,values:qt},At)=>{const Q=Be(At);return{min:Q<x?Q:x,max:Q>G?Q:G,values:qt.includes(Q)?qt:[...qt,Q]}},{min:1/0,max:-1/0,values:[]});_&&(y=Jc,d=Lc,Bt=d-y+1),Pt=Ic.sort((x,G)=>typeof x=="number"&&typeof G=="number"?x-G:typeof x=="number"?1:String(x).localeCompare(String(G))),dt=q?V/Pt.length:V/Bt,T.fillStyle=h,T.globalAlpha=1,u||(T.clearRect(0,0,L,tt),T.fillRect(0,0,L,tt)),t.forEach(x=>{const G=x.whole.begin<=e&&x.endClipped>e;let qt=J??(B&&G),At=!G&&E||G&&S;if(Z&&!G)return;let Q=x.value?.color;l=Q||l,a=H&&Q||a,Q=G?l:a,T.fillStyle=At?Q:"transparent",T.strokeStyle=Q;const{velocity:Wc=1,gain:Hc=1}=x.value||{};T.globalAlpha=Wc*Hc;const Dc=(x.whole.begin-(r?C:ut))/lt,be=Mt(Dc,...j);let Tt=Mt(x.duration/lt,0,M);const ve=Be(x),Vc=q?Pt.indexOf(ve)/Pt.length:(Number(ve)-y)/Bt,_e=Mt(Vc,...Ot);let ke=0;const qe=Mt(e/lt,...j);let Ct;if(k?Ct=[_e+1-(o?dt:0),M-qe+be+ke+1-(r?0:Tt),dt-2,Tt-2]:Ct=[be-qe+ke+1-(r?Tt:0),_e+1-(o?0:dt),Tt-2,dt-2],qt&&T.strokeRect(...Ct),At&&T.fillRect(...Ct),N){const Gc=x.value.note??x.value.s+(x.value.n?`:${x.value.n}`:""),{label:Ae,activeLabel:Qc}=x.value,Uc=(G&&Qc||Ae)??Gc;let Kc=k?Tt:dt*.75;T.font=`${Kc}px ${I||"monospace"}`,T.fillStyle=At?"black":Q,T.textBaseline="top",T.fillText(Uc,...Ct)}}),T.globalAlpha=1;const zt=Mt(-ut/lt,...j);return T.strokeStyle=f,T.beginPath(),k?(T.moveTo(0,zt),T.lineTo(V,zt)):(T.moveTo(zt,0),T.lineTo(zt,V)),T.stroke(),this}function Fc(e,t={}){let[n,s]=e;n=Math.abs(n);const r=s+n,o=n/r;return{fold:1,...t,cycles:r,playhead:o}}const of=(e={})=>(t,n,s,r)=>we({ctx:t,time:n,haps:s,...Fc(r,e)});m.prototype.punchcard=function(e){return this.onPaint(of(e))};m.prototype.wordfall=function(e){return this.punchcard({vertical:1,labels:1,stroke:0,fillActive:1,active:"white",...e})};function Nf(e){const{drawTime:t,...n}=e;we({...Fc(t),...n})}function cf(e,t,n,s){const r=(e-90)*Math.PI/180;return[n+Math.cos(r)*t,s+Math.sin(r)*t]}const Pe=(e,t,n,s,r=0)=>cf((e+r)*360,t*e,n,s);function ze(e){let{ctx:t,from:n=0,to:s=3,margin:r=50,cx:o=100,cy:i=100,rotate:a=0,thickness:l=r/2,color:h=vt().foreground,cap:u="round",stretch:f=1,fromOpacity:y=1,toOpacity:d=1}=e;n*=f,s*=f,a*=f,t.lineWidth=l,t.lineCap=u,t.strokeStyle=h,t.globalAlpha=y,t.beginPath();let[_,w]=Pe(n,r,o,i,a);t.moveTo(_,w);const q=1/60;let k=n;for(;k<=s;){const[N,E]=Pe(k,r,o,i,a);t.globalAlpha=(k-n)/(s-n)*d,t.lineTo(N,E),k+=q}t.stroke()}function af(e){let{stretch:t=1,size:n=80,thickness:s=n/2,cap:r="butt",inset:o=3,playheadColor:i="#ffffff",playheadLength:a=.02,playheadThickness:l=s,padding:h=0,steady:u=1,activeColor:f=vt().foreground,inactiveColor:y=vt().gutterForeground,colorizeInactive:d=0,fade:_=!0,ctx:w,time:q,haps:k,drawTime:N,id:E}=e;E&&(k=k.filter(L=>L.hasTag(E)));const[S,B]=[w.canvas.width,w.canvas.height];w.clearRect(0,0,S*2,B*2);const[J,Z]=[S/2,B/2],H={margin:n/t,cx:J,cy:Z,stretch:t,cap:r,thickness:s},I={...H,thickness:l,from:o-a,to:o,color:i},[T]=N,rt=u*q;k.forEach(L=>{const tt=L.whole.begin<=q&&L.endClipped>q,ut=L.whole.begin-q+o,C=L.endClipped-q+o-h,M=L.value?.color||f,V=d||tt?M:y,j=_?1-Math.abs((L.whole.begin-q)/T):1;ze({ctx:w,...H,from:ut,to:C,rotate:rt,color:V,fromOpacity:j,toOpacity:j})}),ze({ctx:w,...I,rotate:rt})}m.prototype.spiral=function(e={}){return this.onPaint((t,n,s,r)=>af({ctx:t,time:n,haps:s,drawTime:r,...e}))};const uf=ft(36),Ee=(e,t,n,s)=>{s=s*Math.PI*2;const r=Math.sin(s)*n+e,o=Math.cos(s)*n+t;return[r,o]},xe=(e,t)=>.5-Math.log2(e/t)%1;function lf({haps:e,ctx:t,id:n,hapcircles:s=1,circle:r=0,edo:o=12,root:i=uf,thickness:a=3,hapRadius:l=6,mode:h="flake",margin:u=10}={}){const f=h==="polygon",y=h==="flake",d=t.canvas.width,_=t.canvas.height;t.clearRect(0,0,d,_);const w=vt().foreground,k=Math.min(d,_)/2-a/2-l-u,N=d/2,E=_/2;n&&(e=e.filter(B=>B.hasTag(n))),t.strokeStyle=w,t.fillStyle=w,t.globalAlpha=1,t.lineWidth=a,r&&(t.beginPath(),t.arc(N,E,k,0,2*Math.PI),t.stroke()),o&&(Array.from({length:o},(B,J)=>{const Z=xe(i*Math.pow(2,J/o),i),[H,I]=Ee(N,E,k,Z);t.beginPath(),t.arc(H,I,l,0,2*Math.PI),t.fill()}),t.stroke());let S=[];t.lineWidth=l,e.forEach(B=>{let J;try{J=Fe(B)}catch{return}const Z=xe(J,i),[H,I]=Ee(N,E,k,Z),T=B.value.color||w;t.strokeStyle=T,t.fillStyle=T;const{velocity:rt=1,gain:L=1}=B.value||{},tt=rt*L;t.globalAlpha=tt,S.push([H,I,Z,T,tt]),t.beginPath(),s&&(t.moveTo(H+l,I),t.arc(H,I,l,0,2*Math.PI),t.fill()),y&&(t.moveTo(N,E),t.lineTo(H,I)),t.stroke()}),t.strokeStyle=w,t.globalAlpha=1,f&&S.length&&(S=S.sort((B,J)=>B[2]-J[2]),t.beginPath(),t.moveTo(S[0][0],S[0][1]),S.forEach(([B,J,Z,H,I])=>{t.strokeStyle=H,t.globalAlpha=I,t.lineTo(B,J)}),t.lineTo(S[0][0],S[0][1]),t.stroke())}m.prototype.pitchwheel=function(e={}){let{ctx:t=Wt(),id:n=1}=e;return this.tag(n).onPaint((s,r,o)=>lf({...e,time:r,ctx:t,haps:o.filter(i=>i.isActive(r)),id:n}))};let D=[],hf=(e,t)=>{let n=[],s={get(){return s.lc||s.listen(()=>{})(),s.value},l:t||0,lc:0,listen(r,o){return s.lc=n.push(r,o||s.l)/2,()=>{let i=n.indexOf(r);~i&&(n.splice(i,2),--s.lc||s.off())}},notify(r){let o=!D.length;for(let i=0;i<n.length;i+=2)D.push(n[i],n[i+1],s.value,r);if(o){for(let i=0;i<D.length;i+=4){let a;for(let l=i+1;!a&&(l+=4)<D.length;)D[l]<D[i+1]&&(a=D.push(D[i],D[i+1],D[i+2],D[i+3]));a||D[i](D[i+2],D[i+3])}D.length=0}},off(){},set(r){s.value!==r&&(s.value=r,s.notify())},subscribe(r,o){let i=s.listen(r,o);return r(s.value),i},value:e};return s},Of=(e={})=>{let t=hf(e);return t.setKey=function(n,s){typeof s>"u"?n in t.value&&(t.value={...t.value},delete t.value[n],t.notify(n)):t.value[n]!==s&&(t.value={...t.value,[n]:s},t.notify(n))},t};export{Cc as $,la as A,oe as B,W as C,yf as D,Hl as E,rf as F,p as G,Fe as H,ha as I,Zt as J,fa as K,Of as L,df as M,zc as N,xc as O,m as P,He as Q,$t as R,nt as S,P as T,F as U,v as V,cn as W,St as X,et as Y,at as Z,Nt as _,kf as a,Y as a0,b as a1,Sa as a2,ct as a3,hf as a4,tf as a5,Ta as a6,ca as a7,Bc as a8,Ca as a9,Cf as b,mf as c,gf as d,vt as e,Af as f,Wt as g,_f as h,wf as i,Fc as j,of as k,Nf as l,Mf as m,lf as n,Ho as o,we as p,jo as q,qf as r,Tf as s,_t as t,aa as u,ee as v,vf as w,Rc as x,bf as y,Sf as z};
